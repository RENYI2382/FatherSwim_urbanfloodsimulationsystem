<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘è¾¾æ°´FatherSwim - æ™ºèƒ½æ´ªç¾ä»¿çœŸç³»ç»Ÿ</title>
    
    <!-- å¼•å…¥æ ·å¼åº“ -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/leaflet.css') }}" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4ecdc4;
            --warning-color: #ffa07a;
            --danger-color: #ff6b6b;
            --info-color: #45b7d1;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--light-bg) 0%, #e3f2fd 100%);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .main-layout {
            display: flex;
            height: calc(100vh - 76px);
        }
        
        .control-sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease, width 0.3s ease;
            position: relative;
        }
        
        .control-sidebar.collapsed {
            transform: translateX(-320px);
            width: 30px;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 20px;
            right: -40px;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 101;
        }
        
        .sidebar-toggle:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        .control-sidebar.collapsed .sidebar-toggle {
            right: -40px;
        }
        
        .sidebar-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .control-sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .simulation-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .simulation-map {
            flex: 1;
            position: relative;
            background: #f0f0f0;
        }
        
        .bottom-panel {
            height: 200px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        
        .timeline-panel {
            height: 120px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-top: 2px solid var(--primary-color);
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .timeline-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .timeline-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .timeline-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .timeline-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .timeline-time {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
        }
        
        .timeline-step-info {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .timeline-container {
            position: relative;
            width: 100%;
        }
        
        .timeline-track {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
        }
        
        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 50%, #28a745 100%);
            border-radius: 6px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .timeline-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .timeline-thumb {
            position: absolute;
            top: -6px;
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            left: 0%;
            transform: translateX(-50%);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .timeline-thumb:hover {
            transform: translateX(-50%) scale(1.2);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .timeline-thumb-tooltip {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .timeline-thumb:hover .timeline-thumb-tooltip {
            opacity: 1;
        }
        
        .timeline-speed-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            flex-shrink: 0;
        }
        
        .speed-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .speed-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
        }
        
        .speed-slider {
            width: 80px;
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            outline: none;
            cursor: pointer;
        }
        
        .speed-value {
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 35px;
            text-align: center;
        }
        
        .speed-presets {
            display: flex;
            gap: 4px;
        }
        
        .speed-preset {
            padding: 2px 6px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .speed-preset:hover {
            background: #f8f9fa;
        }
        
        .speed-preset.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .control-panel {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-panel h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .control-panel h5 i {
            margin-right: 8px;
        }
        
        .btn-control {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin: 3px;
            transition: all 0.3s ease;
        }
        
        .btn-control:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #26d0ce 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff9a56 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ee5a52 100%);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-running { background: var(--success-color); }
        .status-paused { background: var(--warning-color); }
        .status-stopped { background: var(--danger-color); }
        
        .parameter-group {
            margin-bottom: 20px;
        }
        
        .parameter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 5px;
            display: block;
        }
        
        .form-range {
            margin-bottom: 10px;
        }
        
        .range-value {
            font-size: 0.8rem;
            color: var(--info-color);
            font-weight: bold;
        }
        
        .agent-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .agent-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .agent-item:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }
        
        .agent-item.selected {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-color: var(--primary-color);
        }
        
        .agent-item-info {
            padding: 10px;
            text-align: center;
            color: #666;
            font-style: italic;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
        }
        
        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘é‡ç»˜å’Œé‡æ’ */
        .agent-item {
            will-change: transform;
            backface-visibility: hidden;
            transform: translateZ(0); /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
        }
        
        /* åœ°å›¾æ€§èƒ½ä¼˜åŒ– */
        .leaflet-container {
            will-change: transform;
        }
        
        /* å›¾è¡¨å®¹å™¨ä¼˜åŒ– */
        .chart-container canvas {
            will-change: transform;
        }
        
        /* æ»šåŠ¨æ€§èƒ½ä¼˜åŒ– */
        .agent-list {
            contain: layout style paint;
        }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .loading-spinner {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner p {
            margin: 0;
            color: #666;
            font-size: 16px;
        }
        
        .agent-type {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        .agent-family { background: #e3f2fd; color: #1976d2; }
        .agent-community { background: #f3e5f5; color: #7b1fa2; }
        .agent-universal { background: #e8f5e8; color: #388e3c; }
        
        .chart-mini {
            height: 180px;
            padding: 10px;
        }
        
        .timeline-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-color);
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .scenario-editor {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .scenario-editor h6 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .disaster-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .flood-visualization-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* æ´ªæ°´å±‚åŠ¨ç”»æ ·å¼ */
        .flood-layer {
            transition: all 0.3s ease-in-out;
        }
        
        .flood-level-low {
            animation: gentlePulse 3s ease-in-out infinite;
        }
        
        .flood-level-medium {
            animation: moderatePulse 2.5s ease-in-out infinite;
        }
        
        .flood-level-high {
            animation: strongPulse 2s ease-in-out infinite;
        }
        
        .flood-level-critical {
            animation: criticalPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes gentlePulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.5; }
        }
        
        @keyframes moderatePulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.7; }
        }
        
        @keyframes strongPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.9; }
        }
        
        @keyframes criticalPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1.0; }
        }
        
        /* æ´ªæ°´è·¯å¾„æ ·å¼ */
        .flood-path {
            transition: all 0.3s ease;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .flood-arrow-marker {
            z-index: 1000;
        }
        
        .flood-arrow {
            transition: all 0.2s ease;
        }
        
        /* æµåŠ¨åŠ¨ç”» */
        @keyframes flowAnimation {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -20px;
            }
        }
        
        /* åœ°å›¾å›¾å±‚æ§åˆ¶æ ·å¼ */
        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 8px !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
        }
        
        .leaflet-control-layers-expanded {
            padding: 10px !important;
        }
        
        .leaflet-control-scale {
            background: rgba(255, 255, 255, 0.9) !important;
            border-radius: 4px !important;
            padding: 2px 5px !important;
        }
        
        #map {
            height: 100%;
            width: 100%;
            /* ç¡¬ä»¶åŠ é€Ÿä¼˜åŒ– */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* æ¸²æŸ“ä¼˜åŒ– */
            will-change: transform;
            /* å›¾åƒæ¸²æŸ“ä¼˜åŒ– */
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            /* é˜²æ­¢é€‰æ‹©å’Œæ‹–æ‹½ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* è§¦æ‘¸ä¼˜åŒ– */
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* åœ°å›¾ç“¦ç‰‡ä¼˜åŒ– */
        .leaflet-tile {
            /* å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* å›¾åƒæ¸²æŸ“ä¼˜åŒ– */
            image-rendering: optimizeSpeed;
            /* å‡å°‘é‡ç»˜ */
            will-change: transform;
        }
        
        /* åœ°å›¾å®¹å™¨ä¼˜åŒ– */
        .leaflet-container {
            /* ç¡¬ä»¶åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
            -webkit-overflow-scrolling: touch;
        }
        
        /* åœ°å›¾æ§ä»¶ä¼˜åŒ– */
        .leaflet-control {
            /* å‡å°‘é‡ç»˜ */
            will-change: auto;
        }
        
        .floating-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 200px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--dark-bg);
        }
        
        .info-value {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .agent-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .agent-detail-item label {
            font-weight: 600;
            color: var(--dark-bg);
            margin-bottom: 0;
        }
        
        .agent-detail-item span {
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .agent-detail-item input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        
        .btn-group-vertical .btn {
            margin-bottom: 5px;
            text-align: left;
        }
        
        /* æ™ºèƒ½ä½“çŠ¶æ€æ¨¡æ€æ¡†æ ·å¼ */
        .agent-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .agent-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .agent-id {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }
        
        /* æ™ºèƒ½ä½“æ ‡è®°æ‚¬åœæ•ˆæœ */
        .agent-marker-container:hover .agent-marker-tooltip {
            opacity: 1 !important;
        }
        
        .agent-marker-container:hover .agent-marker-main {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        .agent-marker-label {
            user-select: none;
            pointer-events: none;
        }
        
        .agent-type {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .agent-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .status-normal { background: #d4edda; color: #155724; }
        .status-evacuating { background: #fff3cd; color: #856404; }
        .status-evacuated { background: #d1ecf1; color: #0c5460; }
        .status-helping { background: #f8d7da; color: #721c24; }
        
        .agent-details {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .agent-details .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .agent-details .detail-label {
            font-weight: 500;
        }
        
        .agent-position {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 0.8em;
        }
        
        /* æ™ºèƒ½ä½“æ ‡è®°æ ·å¼ */
        .custom-agent-marker {
            background: transparent !important;
            border: none !important;
        }
        
        .agent-marker-container {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .agent-marker-container:hover {
            transform: scale(1.2);
            z-index: 1000;
        }
        
        .agent-marker-container.highlighted {
            animation: agentHighlight 1s ease-in-out;
            z-index: 1001;
        }
        
        @keyframes agentPulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.3;
            }
            100% {
                transform: scale(1);
                opacity: 0.6;
            }
        }
        
        @keyframes agentHighlight {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            25% {
                transform: scale(1.3);
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 20px rgba(255, 255, 255, 0.1);
            }
            75% {
                transform: scale(1.2);
                box-shadow: 0 0 0 15px rgba(255, 255, 255, 0.2);
            }
        }
        
        /* å¢å¼ºçš„å¼¹å‡ºçª—å£æ ·å¼ */
        .leaflet-popup.agent-popup-enhanced .leaflet-popup-content-wrapper {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
        }
        
        .leaflet-popup.agent-popup-enhanced .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        
        .agent-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .popup-body {
            padding: 16px;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-safe { background: #4caf50; color: white; }
        .status-evacuating { background: #ff9800; color: white; }
        .status-at_risk { background: #f44336; color: white; }
        .status-helping { background: #2196f3; color: white; }
        .status-inactive { background: #9e9e9e; color: white; }
        
        .popup-actions {
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .popup-actions .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .popup-actions .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .popup-actions .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .popup-actions .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .popup-actions .btn-info:hover {
            background: #117a8b;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); padding: 15px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.2);">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="/" style="color: white; text-decoration: none; font-weight: 600; font-size: 1.1em; padding: 8px 16px; border-radius: 25px; background: rgba(255,255,255,0.1); transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">ğŸ  ä¸»é¡µ</a>
                <span style="color: rgba(255,255,255,0.8); font-size: 1.2em;">â€¢</span>
                <span style="color: #fff; font-weight: 700; background: linear-gradient(45deg, #27ae60, #2ecc71); padding: 8px 16px; border-radius: 25px; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-water"></i> å‘è¾¾æ°´FatherSwim
                </span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a href="/dashboard" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 25px; transition: all 0.3s ease; background: rgba(255,255,255,0.1); font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">ğŸ“Š åŸºç¡€ç‰ˆ</a>
                <a href="/enhanced_dashboard" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 25px; transition: all 0.3s ease; background: rgba(255,255,255,0.1); font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">ğŸ“ˆ å¢å¼ºç‰ˆ</a>
                <a href="/project_showcase" style="color: white; text-decoration: none; padding: 8px 16px; border-radius: 25px; transition: all 0.3s ease; background: rgba(255,255,255,0.1); font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">ğŸ¯ å±•ç¤º</a>
                <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 25px;">
                    <span class="status-indicator status-stopped" id="simStatus"></span>
                    <span id="simStatusText" style="color: white; font-size: 0.9em;">ä»¿çœŸå·²åœæ­¢</span>
                </div>
                <button class="btn" onclick="showHelp()" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 16px; border-radius: 25px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">
                    <i class="fas fa-question-circle"></i> å¸®åŠ©
                </button>
            </div>
        </div>
    </nav>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</p>
        </div>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- æ§åˆ¶ä¾§è¾¹æ  -->
        <div class="control-sidebar" id="controlSidebar">
            <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
            <button class="sidebar-toggle" id="sidebarToggle" title="æ”¶èµ·/å±•å¼€ä¾§è¾¹æ ">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="sidebar-content">
                <!-- ä»¿çœŸæ§åˆ¶ -->
            <div class="control-panel">
                <h5><i class="fas fa-play-circle"></i>ä»¿çœŸæ§åˆ¶</h5>
                <div class="d-flex flex-wrap">
                    <button class="btn btn-control btn-success" onclick="startSimulation()">
                        <i class="fas fa-play"></i> å¼€å§‹
                    </button>
                    <button class="btn btn-control btn-warning" onclick="pauseSimulation()">
                        <i class="fas fa-pause"></i> æš‚åœ
                    </button>
                    <button class="btn btn-control btn-danger" onclick="stopSimulation()">
                        <i class="fas fa-stop"></i> åœæ­¢
                    </button>
                    <button class="btn btn-control" onclick="resetSimulation()">
                        <i class="fas fa-redo"></i> é‡ç½®
                    </button>
                </div>
                
                <div class="timeline-controls">
                    <label>é€Ÿåº¦:</label>
                    <input type="range" class="form-range" id="speedControl" min="0.1" max="5" step="0.1" value="1">
                    <span class="range-value" id="speedValue">1.0x</span>
                </div>
                
                <div class="time-display" id="timeDisplay">æ—¶é—´: 00:00:00</div>
            </div>

            <!-- å‚æ•°æ§åˆ¶ -->
            <div class="control-panel">
                <h5><i class="fas fa-sliders-h"></i>å‚æ•°æ§åˆ¶</h5>
                
                <div class="parameter-group">
                    <label>æ™ºèƒ½ä½“æ•°é‡</label>
                    <input type="range" class="form-range" id="agentCount" min="50" max="500" value="200">
                    <span class="range-value" id="agentCountValue">200</span>
                </div>
                
                <div class="parameter-group">
                    <label>æ´ªæ°´å¼ºåº¦</label>
                    <input type="range" class="form-range" id="floodIntensity" min="0" max="1" step="0.1" value="0.3">
                    <span class="range-value" id="floodIntensityValue">0.3</span>
                </div>
                
                <div class="parameter-group">
                    <label>ç¤¾äº¤ç½‘ç»œå¯†åº¦</label>
                    <input type="range" class="form-range" id="networkDensity" min="0.1" max="1" step="0.1" value="0.5">
                    <span class="range-value" id="networkDensityValue">0.5</span>
                </div>
            </div>

            <!-- æ™ºèƒ½ä½“é€‰æ‹© -->
            <div class="control-panel">
                <h5><i class="fas fa-users"></i>æ™ºèƒ½ä½“äº¤äº’</h5>
                <div class="agent-list" id="agentList">
                    <!-- æ™ºèƒ½ä½“åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ™ºèƒ½ä½“è¯¦æƒ…é¢æ¿ -->
            <div class="control-panel" id="agentDetailsPanel" style="display: none;">
                <h5><i class="fas fa-user-cog"></i>æ™ºèƒ½ä½“è¯¦æƒ… <button class="btn btn-sm btn-outline-secondary float-end" onclick="closeAgentDetails()">Ã—</button></h5>
                <div id="agentDetails">
                    <div class="agent-detail-item">
                        <label>ID:</label>
                        <span id="detailAgentId">-</span>
                    </div>
                    <div class="agent-detail-item">
                        <label>ç±»å‹:</label>
                        <span id="detailAgentType">-</span>
                    </div>
                    <div class="agent-detail-item">
                        <label>ä½ç½®:</label>
                        <span id="detailAgentPosition">-</span>
                    </div>
                    <div class="agent-detail-item">
                        <label>èµ„æº:</label>
                        <input type="range" id="detailAgentResources" min="0" max="100" class="form-range" onchange="updateAgentResources()">
                        <span id="detailResourcesValue">0</span>
                    </div>
                    <div class="agent-detail-item">
                        <label>é£é™©ç­‰çº§:</label>
                        <span id="detailAgentRisk">-</span>
                    </div>
                    <div class="agent-detail-item">
                        <label>çŠ¶æ€:</label>
                        <span id="detailAgentStatus">-</span>
                    </div>
                    <div class="mt-3">
                        <h6>è¡Œä¸ºå¹²é¢„</h6>
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-sm btn-outline-primary" onclick="interventeAgent('move_to_safety')">
                                <i class="fas fa-shield-alt"></i> å¼•å¯¼è‡³å®‰å…¨åŒº
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="interventeAgent('increase_caution')">
                                <i class="fas fa-exclamation-triangle"></i> æé«˜è­¦è§‰æ€§
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="interventeAgent('help_others')">
                                <i class="fas fa-hands-helping"></i> ååŠ©ä»–äºº
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="interventeAgent('share_info')">
                                <i class="fas fa-share"></i> åˆ†äº«ä¿¡æ¯
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="interventeAgent('reset_behavior')">
                                <i class="fas fa-undo"></i> é‡ç½®è¡Œä¸º
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœºæ™¯ç¼–è¾‘å™¨ -->
            <div class="control-panel">
                <h5><i class="fas fa-edit"></i>åœºæ™¯ç¼–è¾‘</h5>
                <div class="scenario-editor">
                    <h6>ç¾å®³è®¾ç½®</h6>
                    <div class="disaster-controls">
                        <button class="btn btn-control btn-sm" onclick="addFloodZone()">
                            <i class="fas fa-water"></i> æ·»åŠ æ´ªæ°´
                        </button>
                        <button class="btn btn-control btn-sm" onclick="addSafeZone()">
                            <i class="fas fa-shield-alt"></i> å®‰å…¨åŒºåŸŸ
                        </button>
                        <button class="btn btn-control btn-sm" onclick="addBarrier()">
                            <i class="fas fa-road"></i> é“è·¯é˜»å¡
                        </button>
                        <button class="btn btn-control btn-sm" onclick="exitEditMode()">
                            <i class="fas fa-times"></i> é€€å‡ºç¼–è¾‘
                        </button>
                        <button class="btn btn-control btn-sm" onclick="clearScenario()">
                            <i class="fas fa-trash"></i> æ¸…é™¤
                        </button>
                    </div>
                    
                    <h6 class="mt-3">æ´ªæ°´å¯è§†åŒ–</h6>
                    <div class="flood-visualization-controls">
                        <button class="btn btn-primary btn-sm" id="toggleFloodBtn" onclick="toggleFloodVisualization()">
                            <i class="fas fa-eye"></i> æ˜¾ç¤ºæ´ªæ°´
                        </button>
                        <button class="btn btn-control btn-sm" onclick="clearFloodLayers()">
                            <i class="fas fa-broom"></i> æ¸…é™¤æ´ªæ°´å±‚
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">æç¤ºï¼šå³é”®ç‚¹å‡»åœ°å›¾ä¹Ÿå¯é€€å‡ºç¼–è¾‘æ¨¡å¼</small>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®å¯¼å‡º -->
            <div class="control-panel">
                <h5><i class="fas fa-download"></i>æ•°æ®å¯¼å‡º</h5>
                <div class="export-controls">
                    <button class="btn btn-control btn-sm" onclick="exportSimulationData()">
                        <i class="fas fa-database"></i> å¯¼å‡ºæ•°æ®
                    </button>
                    <button class="btn btn-control btn-sm" onclick="exportCharts()">
                        <i class="fas fa-chart-bar"></i> å¯¼å‡ºå›¾è¡¨
                    </button>
                    <button class="btn btn-control btn-sm" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> ç”ŸæˆæŠ¥å‘Š
                    </button>
                    <button class="btn btn-control btn-sm" onclick="exportScenario()">
                        <i class="fas fa-map"></i> å¯¼å‡ºåœºæ™¯
                    </button>
                </div>
                <div class="mt-2">
                    <small class="text-muted">æ”¯æŒJSONã€CSVã€PNGæ ¼å¼å¯¼å‡º</small>
                </div>
            </div>
            </div> <!-- ç»“æŸ sidebar-content -->
        </div>

        <!-- ä»¿çœŸåŒºåŸŸ -->
        <div class="simulation-area">
            <!-- åœ°å›¾åŒºåŸŸ -->
            <div class="simulation-map">
                <div id="map"></div>
                
                <!-- æµ®åŠ¨ä¿¡æ¯é¢æ¿ -->
                <div class="floating-info">
                    <div class="info-item">
                        <span class="info-label">ä»¿çœŸæ­¥æ•°:</span>
                        <span class="info-value" id="stepCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ´»è·ƒæ™ºèƒ½ä½“:</span>
                        <span class="info-value" id="activeAgents">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç–æ•£äººæ•°:</span>
                        <span class="info-value" id="evacuatedCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¸®åŠ©è¡Œä¸º:</span>
                        <span class="info-value" id="helpActions">0</span>
                    </div>
                    
                    <!-- æ™ºèƒ½ä½“çŠ¶æ€æŒ‰é’® -->
                    <div class="info-item" style="margin-top: 15px;">
                        <button class="btn btn-sm btn-primary w-100" id="showAllAgentsBtn" onclick="showAllAgentsStatus()">
                            <i class="fas fa-users"></i> æŸ¥çœ‹æ‰€æœ‰æ™ºèƒ½ä½“çŠ¶æ€
                        </button>
                    </div>
                    
                    <!-- åœ°å›¾æ€§èƒ½ç›‘æ§ -->
                    <div class="info-item" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                        <span class="info-label">åœ°å›¾æ€§èƒ½:</span>
                        <button class="btn btn-sm btn-outline-info" id="mapPerformanceBtn" onclick="toggleMapPerformance()">
                            <i class="fas fa-tachometer-alt"></i> ç›‘æ§
                        </button>
                    </div>
                    
                    <!-- åœ°å›¾æ€§èƒ½è¯¦æƒ…é¢æ¿ -->
                    <div id="mapPerformancePanel" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.8rem;">
                        <div class="info-item">
                            <span class="info-label">ç“¦ç‰‡åŠ è½½:</span>
                            <span class="info-value" id="tileLoadStatus">å°±ç»ª</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å†…å­˜çŠ¶æ€:</span>
                            <span class="info-value" id="memoryStatus">æ­£å¸¸</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ¸²æŸ“æ¨¡å¼:</span>
                            <span class="info-value" id="renderMode">Canvas</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ç¼“å­˜ç“¦ç‰‡:</span>
                            <span class="info-value" id="cachedTiles">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨é¢æ¿ -->
            <div class="bottom-panel">
                <div class="chart-mini" style="flex: 1;">
                    <canvas id="populationChart"></canvas>
                </div>
                <div class="chart-mini" style="flex: 1;">
                    <canvas id="behaviorChart"></canvas>
                </div>
                <div class="chart-mini" style="flex: 1;">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
            
            <!-- å¢å¼ºæ—¶é—´è½´é¢æ¿ -->
            <div class="timeline-panel">
                <!-- å·¦ä¾§æ§åˆ¶æŒ‰é’® -->
                <div class="timeline-controls">
                    <button class="timeline-btn" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="timeline-btn" id="resetBtn" title="é‡ç½®">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="timeline-btn" id="stepForwardBtn" title="å•æ­¥å‰è¿›">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="timeline-btn" id="stepBackwardBtn" title="å•æ­¥åé€€">
                        <i class="fas fa-step-backward"></i>
                    </button>
                </div>
                
                <!-- ä¸­å¤®æ—¶é—´è½´åŒºåŸŸ -->
                <div class="timeline-main">
                    <!-- æ—¶é—´å’Œæ­¥æ•°æ˜¾ç¤º -->
                    <div class="timeline-display">
                        <div class="timeline-time" id="timelineTime">00:00:00</div>
                        <div class="timeline-step-info">
                            <span id="timelineStep">0</span> / <span id="timelineMaxStep">1000</span> æ­¥
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡å®¹å™¨ -->
                    <div class="timeline-container">
                        <div class="timeline-track">
                            <!-- èƒŒæ™¯åˆ»åº¦çº¿ -->
                            <div class="timeline-markers" id="timelineMarkers"></div>
                            <!-- è¿›åº¦æ¡ -->
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <!-- æ‹–æ‹½æ»‘å— -->
                            <div class="timeline-thumb" id="timelineThumb">
                                <div class="timeline-thumb-tooltip" id="timelineTooltip">æ­¥æ•°: 0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§é€Ÿåº¦æ§åˆ¶ -->
                <div class="timeline-speed-control">
                    <div class="speed-label">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>é€Ÿåº¦</span>
                    </div>
                    <div class="speed-slider-container">
                        <input type="range" class="speed-slider" id="speedControl" 
                               min="0.1" max="5" step="0.1" value="1">
                        <div class="speed-value" id="speedValue">1.0x</div>
                    </div>
                    <div class="speed-presets">
                        <button class="speed-preset" data-speed="0.5">0.5x</button>
                        <button class="speed-preset active" data-speed="1">1x</button>
                        <button class="speed-preset" data-speed="2">2x</button>
                        <button class="speed-preset" data-speed="5">5x</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™ºèƒ½ä½“çŠ¶æ€æ¨¡æ€æ¡† -->
    <div class="modal fade" id="agentStatusModal" tabindex="-1" aria-labelledby="agentStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentStatusModalLabel">
                        <i class="fas fa-users"></i> æ‰€æœ‰æ™ºèƒ½ä½“çŠ¶æ€
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="agentSearchInput" placeholder="æœç´¢æ™ºèƒ½ä½“ (ID, ç±»å‹, çŠ¶æ€...)">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="agentTypeFilter">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="æ™®é€šå±…æ°‘">æ™®é€šå±…æ°‘</option>
                                <option value="ç¤¾åŒºé¢†è¢–">ç¤¾åŒºé¢†è¢–</option>
                                <option value="æ•‘æ´äººå‘˜">æ•‘æ´äººå‘˜</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="agentStatusFilter">
                                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                                <option value="æ­£å¸¸">æ­£å¸¸</option>
                                <option value="ç–æ•£ä¸­">ç–æ•£ä¸­</option>
                                <option value="å·²ç–æ•£">å·²ç–æ•£</option>
                                <option value="å¸®åŠ©ä»–äºº">å¸®åŠ©ä»–äºº</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="agent-status-grid" id="agentStatusGrid">
                        <!-- æ™ºèƒ½ä½“çŠ¶æ€å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="text-center mt-3" id="agentStatusLoading" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="refreshAgentStatus()">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥JavaScriptåº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let map;
        let simulationState = 'stopped';
        let currentStep = 0;
        let simulationSpeed = 1.0;
        let selectedAgent = null;
        let agents = [];
        let charts = {};
        let ws = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Leaflet to load before initializing map
            if (typeof L !== 'undefined') {
                initializeMap();
            } else {
                setTimeout(() => {
                    if (typeof L !== 'undefined') {
                        initializeMap();
                    }
                }, 1000);
            }
            // Wait for Chart.js to load before initializing charts
            if (typeof Chart !== 'undefined') {
                initializeCharts();
            } else {
                setTimeout(() => {
                    if (typeof Chart !== 'undefined') {
                        initializeCharts();
                    }
                }, 1000);
            }
            // Wait for Socket.IO to load before initializing WebSocket
            if (typeof io !== 'undefined') {
                initializeWebSocket();
            } else {
                setTimeout(() => {
                    if (typeof io !== 'undefined') {
                        initializeWebSocket();
                    }
                }, 1000);
            }
            initializeControls();
            
            // å»¶è¿Ÿç”Ÿæˆæ™ºèƒ½ä½“ï¼Œç¡®ä¿åœ°å›¾å·²åˆå§‹åŒ–
            setTimeout(() => {
                if (typeof L !== 'undefined' && map) {
                    generateSampleAgents();
                }
            }, 2000);
        });
        
        // åœ°å›¾æ€§èƒ½ä¼˜åŒ–é…ç½®
        const mapConfig = {
            // ç“¦ç‰‡ç¼“å­˜é…ç½®
            tileCache: {
                maxSize: 100, // æœ€å¤§ç¼“å­˜ç“¦ç‰‡æ•°
                maxAge: 300000 // ç¼“å­˜æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
            },
            // æ¸²æŸ“ä¼˜åŒ–
            rendering: {
                preferCanvas: true, // ä½¿ç”¨Canvasæ¸²æŸ“æå‡æ€§èƒ½
                updateWhenIdle: true, // ä»…åœ¨ç©ºé—²æ—¶æ›´æ–°
                updateWhenZooming: false, // ç¼©æ”¾æ—¶ä¸æ›´æ–°
                keepBuffer: 2 // ä¿æŒç¼“å†²åŒºå¤§å°
            },
            // å†…å­˜ç®¡ç†
            memory: {
                maxZoom: 18, // é™åˆ¶æœ€å¤§ç¼©æ”¾çº§åˆ«
                minZoom: 8,  // é™åˆ¶æœ€å°ç¼©æ”¾çº§åˆ«
                tileSize: 256, // æ ‡å‡†ç“¦ç‰‡å¤§å°
                zoomOffset: 0
            }
        };

        // åˆå§‹åŒ–åœ°å›¾
        function initializeMap() {
            // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼Œåº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®
            map = L.map('map', {
                preferCanvas: mapConfig.rendering.preferCanvas,
                updateWhenIdle: mapConfig.rendering.updateWhenIdle,
                updateWhenZooming: mapConfig.rendering.updateWhenZooming,
                keepBuffer: mapConfig.rendering.keepBuffer,
                maxZoom: mapConfig.memory.maxZoom,
                minZoom: mapConfig.memory.minZoom
            }).setView([39.9042, 116.4074], 12);
            
            // å®šä¹‰ä¼˜åŒ–çš„åœ°å›¾å›¾å±‚
            const baseMaps = {
                "é«˜æ€§èƒ½åœ°å›¾": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: mapConfig.memory.maxZoom,
                    minZoom: mapConfig.memory.minZoom,
                    tileSize: mapConfig.memory.tileSize,
                    updateWhenIdle: true,
                    updateWhenZooming: false,
                    keepBuffer: 2,
                    // å¯ç”¨ç“¦ç‰‡ç¼“å­˜
                    crossOrigin: true
                }),
                "å«æ˜Ÿåœ°å›¾": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Â© Esri, DigitalGlobe, GeoEye, Earthstar Geographics',
                    maxZoom: 16, // é™åˆ¶å«æ˜Ÿå›¾æœ€å¤§ç¼©æ”¾ä»¥èŠ‚çœå†…å­˜
                    minZoom: mapConfig.memory.minZoom,
                    updateWhenIdle: true
                }),
                "è½»é‡åœ°å½¢": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap contributors',
                    maxZoom: 15, // åœ°å½¢å›¾é™åˆ¶æ›´ä½ç¼©æ”¾çº§åˆ«
                    minZoom: mapConfig.memory.minZoom,
                    updateWhenIdle: true
                }),
                "ç®€åŒ–æ°´æ–‡": L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png', {
                    attribution: 'Â© Stamen Design, Â© OpenStreetMap contributors',
                    maxZoom: 14, // æ°´æ–‡å›¾ä½¿ç”¨è¾ƒä½åˆ†è¾¨ç‡
                    minZoom: mapConfig.memory.minZoom,
                    updateWhenIdle: true
                })
            };
            
            // é»˜è®¤æ·»åŠ é«˜æ€§èƒ½åœ°å›¾
            baseMaps["é«˜æ€§èƒ½åœ°å›¾"].addTo(map);
            
            // æ·»åŠ å›¾å±‚æ§åˆ¶å™¨
            const layerControl = L.control.layers(baseMaps, {}, {
                position: 'topright',
                collapsed: false
            }).addTo(map);
            
            // æ·»åŠ æ¯”ä¾‹å°º
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);
            
            // åœ°å›¾æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
            let tileLoadCount = 0;
            let lastTileLoadTime = Date.now();
            
            // ç›‘å¬ç“¦ç‰‡åŠ è½½äº‹ä»¶
            map.on('tileloadstart', function() {
                tileLoadCount++;
            });
            
            map.on('tileload', function() {
                tileLoadCount--;
                lastTileLoadTime = Date.now();
            });
            
            // å†…å­˜æ¸…ç†å‡½æ•°
            function cleanupMapMemory() {
                // æ¸…ç†æœªä½¿ç”¨çš„ç“¦ç‰‡
                map.eachLayer(function(layer) {
                    if (layer._tiles) {
                        const now = Date.now();
                        Object.keys(layer._tiles).forEach(key => {
                            const tile = layer._tiles[key];
                            if (tile.loaded && (now - tile.loadTime) > mapConfig.tileCache.maxAge) {
                                delete layer._tiles[key];
                            }
                        });
                    }
                });
            }
            
            // å®šæœŸæ¸…ç†å†…å­˜ï¼ˆæ¯30ç§’ï¼‰
            setInterval(cleanupMapMemory, 30000);
            
            // åœ°å›¾ç§»åŠ¨ç»“æŸåçš„ä¼˜åŒ–
            map.on('moveend', function() {
                // å»¶è¿Ÿæ¸…ç†ï¼Œé¿å…é¢‘ç¹æ“ä½œ
                setTimeout(cleanupMapMemory, 2000);
            });
            
            // ç¼©æ”¾ç»“æŸåçš„ä¼˜åŒ–
             map.on('zoomend', function() {
                 // æ¸…ç†ä¸éœ€è¦çš„ç¼©æ”¾çº§åˆ«ç“¦ç‰‡
                 setTimeout(cleanupMapMemory, 1000);
             });
             
             // æ€§èƒ½ç›‘æ§æ•°æ®æ›´æ–°
             function updateMapPerformance() {
                 if (document.getElementById('mapPerformancePanel').style.display !== 'none') {
                     // æ›´æ–°ç“¦ç‰‡åŠ è½½çŠ¶æ€
                     const tileStatus = tileLoadCount > 0 ? `åŠ è½½ä¸­(${tileLoadCount})` : 'å°±ç»ª';
                     document.getElementById('tileLoadStatus').textContent = tileStatus;
                     
                     // æ›´æ–°å†…å­˜çŠ¶æ€
                     let totalTiles = 0;
                     map.eachLayer(function(layer) {
                         if (layer._tiles) {
                             totalTiles += Object.keys(layer._tiles).length;
                         }
                     });
                     
                     const memoryStatus = totalTiles > 200 ? 'é«˜è´Ÿè½½' : totalTiles > 100 ? 'ä¸­ç­‰' : 'æ­£å¸¸';
                     document.getElementById('memoryStatus').textContent = memoryStatus;
                     document.getElementById('cachedTiles').textContent = totalTiles;
                     
                     // æ›´æ–°å†…å­˜çŠ¶æ€é¢œè‰²
                     const memoryElement = document.getElementById('memoryStatus');
                     memoryElement.style.color = totalTiles > 200 ? '#dc3545' : totalTiles > 100 ? '#ffc107' : '#28a745';
                 }
             }
             
             // å®šæœŸæ›´æ–°æ€§èƒ½æ•°æ®ï¼ˆæ¯2ç§’ï¼‰
             setInterval(updateMapPerformance, 2000);
             
             // åˆå§‹åŒ–æ€§èƒ½æ•°æ®
             updateMapPerformance();
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            map.on('click', function(e) {
                // ä¼˜å…ˆå¤„ç†åœºæ™¯ç¼–è¾‘
                if (editMode) {
                    handleMapClick(e);
                } else if (selectedAgent) {
                    moveAgentTo(selectedAgent, e.latlng);
                }
            });
            
            // æ·»åŠ å³é”®ç‚¹å‡»é€€å‡ºç¼–è¾‘æ¨¡å¼
            map.on('contextmenu', function(e) {
                if (editMode) {
                    exitEditMode();
                    e.originalEvent.preventDefault();
                }
            });
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initializeCharts() {
            // äººå£åˆ†å¸ƒå›¾è¡¨
            const popCtx = document.getElementById('populationChart').getContext('2d');
            charts.population = new Chart(popCtx, {
                type: 'doughnut',
                data: {
                    labels: ['å®¶åº­å‹', 'ç¤¾åŒºå‹', 'æ™®ä¸–å‹'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#e3f2fd', '#f3e5f5', '#e8f5e8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ™ºèƒ½ä½“ç±»å‹åˆ†å¸ƒ'
                        }
                    }
                }
            });
            
            // è¡Œä¸ºç»Ÿè®¡å›¾è¡¨
            const behaviorCtx = document.getElementById('behaviorChart').getContext('2d');
            charts.behavior = new Chart(behaviorCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å¸®åŠ©è¡Œä¸º',
                        data: [],
                        borderColor: '#4ecdc4',
                        tension: 0.1
                    }, {
                        label: 'ç–æ•£è¡Œä¸º',
                        data: [],
                        borderColor: '#ff6b6b',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'è¡Œä¸ºç»Ÿè®¡'
                        }
                    }
                }
            });
            
            // é£é™©åˆ†å¸ƒå›¾è¡¨
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            charts.risk = new Chart(riskCtx, {
                type: 'bar',
                data: {
                    labels: ['ä½é£é™©', 'ä¸­é£é™©', 'é«˜é£é™©'],
                    datasets: [{
                        label: 'åŒºåŸŸæ•°é‡',
                        data: [0, 0, 0],
                        backgroundColor: ['#4ecdc4', '#ffa07a', '#ff6b6b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'é£é™©åŒºåŸŸåˆ†å¸ƒ'
                        }
                    }
                }
            });
        }
        
        // å…¨å±€å·¥å…·å‡½æ•°
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ‰¹é‡æ›´æ–°é˜Ÿåˆ—ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
        let updateQueue = [];
        let isProcessingQueue = false;
        
        function processUpdateQueue() {
            if (isProcessingQueue || updateQueue.length === 0) return;
            
            isProcessingQueue = true;
            requestAnimationFrame(() => {
                const updates = [...updateQueue];
                updateQueue = [];
                
                // æ‰¹é‡å¤„ç†æ›´æ–°
                const agentUpdates = updates.filter(u => u.type === 'agent');
                const mapUpdates = updates.filter(u => u.type === 'map');
                
                if (agentUpdates.length > 0) {
                    updateAgentList();
                }
                if (mapUpdates.length > 0) {
                    displayAgentsOnMap();
                }
                
                isProcessingQueue = false;
            });
        }
        
        function queueUpdate(type) {
            updateQueue.push({type, timestamp: Date.now()});
            processUpdateQueue();
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initializeWebSocket() {
            // ä½¿ç”¨Socket.IOå®¢æˆ·ç«¯
            window.socket = io();
            ws = window.socket;
            
            ws.on('connect', function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                // è¿æ¥æˆåŠŸåéšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideLoadingIndicator();
                
                // åŠ å…¥simulationæˆ¿é—´ä»¥æ¥æ”¶ä»¿çœŸæ•°æ®
                ws.emit('join', {room: 'simulation'});
                
                // è‡ªåŠ¨å¯åŠ¨ä»¿çœŸä»¥æ˜¾ç¤ºåœ°å›¾å’Œæ™ºèƒ½ä½“
                setTimeout(() => {
                    console.log('è‡ªåŠ¨å¯åŠ¨ä»¿çœŸ');
                    startSimulation();
                }, 1000);
            });
            
            ws.on('status', function(data) {
                console.log('æ”¶åˆ°çŠ¶æ€æ›´æ–°:', data);
                simulationState = data.status;
                updateSimulationStatus();
            });
            
            ws.on('scenario_update', debounce(function(data) {
                console.log('æ”¶åˆ°åœºæ™¯æ›´æ–°:', data);
                loadScenarioFromData(data);
            }, 200));
            
            // ç›‘å¬æ™ºèƒ½ä½“æ›´æ–°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            ws.on('agent_updated', throttle(function(data) {
                // æ›´æ–°æœ¬åœ°æ™ºèƒ½ä½“æ•°æ®
                const agent = agents.find(a => a.id === data.agentId);
                if (agent) {
                    if (data.property === 'resources') {
                        agent.resources = data.value;
                    } else if (data.property === 'risk') {
                        agent.risk = data.value;
                    } else if (data.property === 'position') {
                        agent.position = data.value;
                    }
                    
                    // ä½¿ç”¨é˜Ÿåˆ—æ‰¹é‡æ›´æ–°ç•Œé¢
                    queueUpdate('agent');
                    queueUpdate('map');
                    
                    // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¿™ä¸ªæ™ºèƒ½ä½“ï¼Œæ›´æ–°è¯¦æƒ…é¢æ¿
                    if (selectedAgent && selectedAgent.id === data.agentId) {
                        requestAnimationFrame(() => showAgentDetails(agent));
                    }
                }
            }, 50));
            
            // ç›‘å¬æ™ºèƒ½ä½“å¹²é¢„ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
            ws.on('agent_intervention', function(data) {
                // æ›´æ–°æœ¬åœ°æ™ºèƒ½ä½“æ•°æ®
                const agent = agents.find(a => a.id === data.agentId);
                if (agent) {
                    // æ›´æ–°æ™ºèƒ½ä½“çŠ¶æ€
                    Object.assign(agent, data.agent);
                    
                    // ä½¿ç”¨é˜Ÿåˆ—æ‰¹é‡æ›´æ–°ç•Œé¢
                    queueUpdate('agent');
                    queueUpdate('map');
                    
                    // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¿™ä¸ªæ™ºèƒ½ä½“ï¼Œæ›´æ–°è¯¦æƒ…é¢æ¿
                    if (selectedAgent && selectedAgent.id === data.agentId) {
                        requestAnimationFrame(() => showAgentDetails(agent));
                    }
                    
                    // æ˜¾ç¤ºå¹²é¢„æˆåŠŸæç¤º
                    const actionNames = {
                        'move_to_safety': 'å¼•å¯¼è‡³å®‰å…¨åŒº',
                        'increase_caution': 'æé«˜è­¦è§‰æ€§',
                        'help_others': 'ååŠ©ä»–äºº',
                        'share_info': 'åˆ†äº«ä¿¡æ¯',
                        'reset_behavior': 'é‡ç½®è¡Œä¸º'
                    };
                    
                    showNotification(`æ™ºèƒ½ä½“ ${data.agentId} å¹²é¢„æˆåŠŸï¼š${actionNames[data.action]}`, 'success');
                }
            });
            
            ws.on('simulation_update', throttle(function(data) {
                requestAnimationFrame(() => handleSimulationUpdate(data));
            }, 100));
            
            ws.on('status_update', throttle(function(data) {
                simulationState = data.status;
                requestAnimationFrame(() => updateSimulationStatus());
            }, 200));
            
            // å¤„ç†ä»¿çœŸæš‚åœäº‹ä»¶
            ws.on('simulation_paused', function(data) {
                console.log('ä»¿çœŸå·²æš‚åœ:', data);
                if (data.reason === 'max_steps_reached') {
                    showNotification(data.message, 'warning', 5000);
                    // æ›´æ–°UIçŠ¶æ€
                    isSimulationPaused = true;
                    updateSimulationControls();
                }
            });
            
            ws.on('agent_moved', throttle(function(data) {
                console.log('æ™ºèƒ½ä½“ç§»åŠ¨:', data);
                // ä¼˜åŒ–ï¼šåªåœ¨å¿…è¦æ—¶æ›´æ–°åœ°å›¾
                queueUpdate('map');
            }, 16)); // çº¦60fps
            
            ws.on('disconnect', function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                showNotification('ä¸æœåŠ¡å™¨è¿æ¥æ–­å¼€', 'error');
            });
        }
        
        // åˆå§‹åŒ–æ§ä»¶
        function initializeControls() {
            // é€Ÿåº¦æ§åˆ¶å·²ç§»è‡³ initializeTimeline å‡½æ•°ä¸­
            
            // å‚æ•°æ§åˆ¶
            ['agentCount', 'floodIntensity', 'networkDensity'].forEach(id => {
                document.getElementById(id).addEventListener('input', function(e) {
                    document.getElementById(id + 'Value').textContent = e.target.value;
                    updateParameter(id, e.target.value);
                });
            });
        }
        
        // ç”Ÿæˆç¤ºä¾‹æ™ºèƒ½ä½“
        function generateSampleAgents() {
            const agentTypes = ['family', 'community', 'universal'];
            const typeNames = ['å®¶åº­å‹', 'ç¤¾åŒºå‹', 'æ™®ä¸–å‹'];
            const typeClasses = ['agent-family', 'agent-community', 'agent-universal'];
            
            agents = [];
            for (let i = 0; i < 50; i++) {
                const typeIndex = Math.floor(Math.random() * 3);
                agents.push({
                    id: `agent_${i}`,
                    type: agentTypes[typeIndex],
                    typeName: typeNames[typeIndex],
                    typeClass: typeClasses[typeIndex],
                    position: {
                        lat: 39.9042 + (Math.random() - 0.5) * 0.1,
                        lng: 116.4074 + (Math.random() - 0.5) * 0.1
                    },
                    status: 'active',
                    resources: Math.floor(Math.random() * 100),
                    risk: Math.random()
                });
            }
            
            updateAgentList();
            updateCharts();
            displayAgentsOnMap();
        }
        
        // ä¼˜åŒ–çš„æ™ºèƒ½ä½“åœ°å›¾æ˜¾ç¤º
        let agentMarkersMap = new Map(); // ä½¿ç”¨Mapæ¥è·Ÿè¸ªæ ‡è®°
        let lastAgentCount = 0;
        
        function displayAgentsOnMap() {
            // æ£€æŸ¥åœ°å›¾å’ŒLeafletåº“æ˜¯å¦å¯ç”¨
            if (typeof L === 'undefined' || !map) {
                console.log('åœ°å›¾æˆ–Leafletåº“æœªå‡†å¤‡å¥½');
                return;
            }
            
            // æ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœæ™ºèƒ½ä½“æ•°é‡æ²¡æœ‰å˜åŒ–ï¼Œåªæ›´æ–°ä½ç½®
            if (agents.length === lastAgentCount && agentMarkersMap.size > 0) {
                updateAgentPositions();
                return;
            }
            
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            agentMarkersMap.forEach(marker => map.removeLayer(marker));
            agentMarkersMap.clear();
            
            // æ‰¹é‡åˆ›å»ºæ ‡è®°
            const markersToAdd = [];
            agents.forEach(agent => {
                const marker = createEnhancedAgentMarker(agent);
                agentMarkersMap.set(agent.id, marker);
                markersToAdd.push(marker);
            });
            
            // æ‰¹é‡æ·»åŠ åˆ°åœ°å›¾
            const group = L.layerGroup(markersToAdd).addTo(map);
            lastAgentCount = agents.length;
        }
        
        // åˆ›å»ºå¢å¼ºçš„æ™ºèƒ½ä½“æ ‡è®°
        function createEnhancedAgentMarker(agent) {
            // æ ¹æ®æ™ºèƒ½ä½“ç±»å‹å’ŒçŠ¶æ€ç¡®å®šé¢œè‰²å’Œå¤§å°
            const typeColors = {
                'family': '#ff6b6b',
                'community': '#4ecdc4', 
                'individual': '#667eea',
                'elderly': '#ffa726',
                'child': '#66bb6a'
            };
            
            const statusColors = {
                'safe': '#4caf50',
                'evacuating': '#ff9800',
                'at_risk': '#f44336',
                'helping': '#2196f3',
                'inactive': '#9e9e9e'
            };
            
            const baseColor = typeColors[agent.type] || '#667eea';
            const statusColor = statusColors[agent.status] || baseColor;
            
            // æ ¹æ®èµ„æºå’Œé£é™©è°ƒæ•´æ ‡è®°å¤§å°
            const resourceFactor = Math.max(0.5, agent.resources / 100);
            const riskFactor = Math.max(0.5, agent.risk);
            const baseRadius = 8;
            const radius = baseRadius * resourceFactor * (2 - riskFactor);
            
            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
            const iconHtml = `
                <div class="agent-marker-container" data-agent-id="${agent.id}">
                    <div class="agent-marker-main" style="
                        background-color: ${baseColor};
                        border: 3px solid ${statusColor};
                        width: ${radius * 2}px;
                        height: ${radius * 2}px;
                        border-radius: 50%;
                        position: relative;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">
                        <div class="agent-marker-pulse" style="
                            position: absolute;
                            top: -2px;
                            left: -2px;
                            right: -2px;
                            bottom: -2px;
                            border: 2px solid ${statusColor};
                            border-radius: 50%;
                            animation: agentPulse 2s infinite;
                            opacity: 0.6;
                        "></div>
                        <div class="agent-marker-label" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: white;
                            font-size: ${Math.max(10, radius * 0.8)}px;
                            font-weight: bold;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                            font-family: 'Arial', sans-serif;
                        ">${agent.id.replace('agent_', '')}</div>
                    </div>
                    <div class="agent-marker-tooltip" style="
                        position: absolute;
                        top: -35px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        white-space: nowrap;
                        opacity: 0;
                        transition: opacity 0.3s;
                        pointer-events: none;
                        z-index: 1000;
                    ">${agent.id}</div>
                    </div>
                    <div class="agent-marker-status" style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        width: 12px;
                        height: 12px;
                        background-color: ${statusColor};
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                    "></div>
                </div>
            `;
            
            const marker = L.marker([agent.position.lat, agent.position.lng], {
                icon: L.divIcon({
                    className: 'custom-agent-marker',
                    html: iconHtml,
                    iconSize: [radius * 2 + 10, radius * 2 + 10],
                    iconAnchor: [radius + 5, radius + 5]
                })
            });
            
            // å¢å¼ºçš„å¼¹å‡ºçª—å£
            const popupContent = createEnhancedPopup(agent);
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'agent-popup-enhanced'
            });
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            marker.on('click', function() {
                selectAgent(agent);
                focusOnAgent(agent);
            });
            
            return marker;
        }
        
        // åˆ›å»ºå¢å¼ºçš„å¼¹å‡ºçª—å£å†…å®¹
        function createEnhancedPopup(agent) {
            const resourceBar = createResourceBar(agent.resources);
            const riskBar = createRiskBar(agent.risk);
            
            return `
                <div class="agent-popup-content">
                    <div class="popup-header">
                        <h4 style="margin: 0; color: #333;">
                            <i class="fas fa-user"></i> ${agent.id}
                        </h4>
                        <span class="agent-type-badge" style="
                            background: ${getTypeColor(agent.type)};
                            color: white;
                            padding: 2px 8px;
                            border-radius: 12px;
                            font-size: 12px;
                        ">${agent.typeName || agent.type}</span>
                    </div>
                    
                    <div class="popup-body" style="margin-top: 10px;">
                        <div class="status-row" style="margin-bottom: 8px;">
                            <strong>çŠ¶æ€:</strong> 
                            <span class="status-badge status-${agent.status}">${agent.status}</span>
                        </div>
                        
                        <div class="resource-row" style="margin-bottom: 8px;">
                            <strong>èµ„æº:</strong> ${agent.resources}%
                            <div style="margin-top: 3px;">${resourceBar}</div>
                        </div>
                        
                        <div class="risk-row" style="margin-bottom: 8px;">
                            <strong>é£é™©ç­‰çº§:</strong> ${(agent.risk * 100).toFixed(1)}%
                            <div style="margin-top: 3px;">${riskBar}</div>
                        </div>
                        
                        <div class="position-row" style="font-size: 12px; color: #666;">
                            <strong>ä½ç½®:</strong> ${agent.position.lat.toFixed(4)}, ${agent.position.lng.toFixed(4)}
                        </div>
                    </div>
                    
                    <div class="popup-actions" style="margin-top: 10px; text-align: center;">
                        <button onclick="focusOnAgent(agents.find(a => a.id === '${agent.id}'))" 
                                class="btn btn-sm btn-primary" style="margin-right: 5px;">
                            <i class="fas fa-crosshairs"></i> èšç„¦
                        </button>
                        <button onclick="selectAgent(agents.find(a => a.id === '${agent.id}'))" 
                                class="btn btn-sm btn-info">
                            <i class="fas fa-info-circle"></i> è¯¦æƒ…
                        </button>
                    </div>
                </div>
            `;
        }
        
        // åˆ›å»ºèµ„æºè¿›åº¦æ¡
        function createResourceBar(resources) {
            const percentage = Math.max(0, Math.min(100, resources));
            const color = percentage > 70 ? '#4caf50' : percentage > 30 ? '#ff9800' : '#f44336';
            
            return `
                <div style="
                    width: 100%;
                    height: 6px;
                    background: #e0e0e0;
                    border-radius: 3px;
                    overflow: hidden;
                ">
                    <div style="
                        width: ${percentage}%;
                        height: 100%;
                        background: ${color};
                        transition: width 0.3s ease;
                    "></div>
                </div>
            `;
        }
        
        // åˆ›å»ºé£é™©è¿›åº¦æ¡
        function createRiskBar(risk) {
            const percentage = Math.max(0, Math.min(100, risk * 100));
            const color = percentage < 30 ? '#4caf50' : percentage < 70 ? '#ff9800' : '#f44336';
            
            return `
                <div style="
                    width: 100%;
                    height: 6px;
                    background: #e0e0e0;
                    border-radius: 3px;
                    overflow: hidden;
                ">
                    <div style="
                        width: ${percentage}%;
                        height: 100%;
                        background: ${color};
                        transition: width 0.3s ease;
                    "></div>
                </div>
            `;
        }
        
        // è·å–ç±»å‹é¢œè‰²
        function getTypeColor(type) {
            const colors = {
                'family': '#ff6b6b',
                'community': '#4ecdc4',
                'individual': '#667eea',
                'elderly': '#ffa726',
                'child': '#66bb6a'
            };
            return colors[type] || '#667eea';
        }
        
        // èšç„¦åˆ°æ™ºèƒ½ä½“
        function focusOnAgent(agent) {
            if (!agent || !map) return;
            
            // å¹³æ»‘ç¼©æ”¾åˆ°æ™ºèƒ½ä½“ä½ç½®
            map.flyTo([agent.position.lat, agent.position.lng], 16, {
                duration: 1.5,
                easeLinearity: 0.25
            });
            
            // é«˜äº®æ˜¾ç¤ºæ™ºèƒ½ä½“
            highlightAgent(agent.id);
            
            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            setTimeout(() => {
                selectAgent(agent);
            }, 1000);
        }
        
        // é«˜äº®æ˜¾ç¤ºæ™ºèƒ½ä½“
        function highlightAgent(agentId) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.agent-marker-container').forEach(marker => {
                marker.classList.remove('highlighted');
            });
            
            // é«˜äº®é€‰ä¸­çš„æ™ºèƒ½ä½“
            const markerElement = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (markerElement) {
                markerElement.classList.add('highlighted');
                
                // 3ç§’åç§»é™¤é«˜äº®
                setTimeout(() => {
                    markerElement.classList.remove('highlighted');
                }, 3000);
            }
        }
        
        // åªæ›´æ–°æ™ºèƒ½ä½“ä½ç½®ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
        function updateAgentPositions() {
            agents.forEach(agent => {
                const marker = agentMarkersMap.get(agent.id);
                if (marker) {
                    const currentLatLng = marker.getLatLng();
                    const newLatLng = [agent.position.lat, agent.position.lng];
                    
                    // åªåœ¨ä½ç½®çœŸæ­£æ”¹å˜æ—¶æ›´æ–°
                    if (Math.abs(currentLatLng.lat - newLatLng[0]) > 0.0001 || 
                        Math.abs(currentLatLng.lng - newLatLng[1]) > 0.0001) {
                        marker.setLatLng(newLatLng);
                    }
                }
            });
        }
        
        // ä¼˜åŒ–çš„æ™ºèƒ½ä½“åˆ—è¡¨æ›´æ–°
        let agentListCache = new Map();
        let lastListUpdateTime = 0;
        const LIST_UPDATE_THROTTLE = 200; // 200msèŠ‚æµ
        
        function updateAgentList() {
            const now = Date.now();
            if (now - lastListUpdateTime < LIST_UPDATE_THROTTLE) {
                return; // èŠ‚æµï¼šè·³è¿‡è¿‡äºé¢‘ç¹çš„æ›´æ–°
            }
            lastListUpdateTime = now;
            
            const agentList = document.getElementById('agentList');
            if (!agentList) return;
            
            // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ“ä½œDOM
            const fragment = document.createDocumentFragment();
            const existingItems = new Set();
            
            // æ”¶é›†ç°æœ‰çš„æ™ºèƒ½ä½“é¡¹ç›®
            Array.from(agentList.children).forEach(child => {
                const agentId = child.dataset.agentId;
                if (agentId) {
                    existingItems.add(agentId);
                    agentListCache.set(agentId, child);
                }
            });
            
            // æ¸…ç©ºåˆ—è¡¨
            agentList.innerHTML = '';
            
            // é™åˆ¶æ˜¾ç¤ºçš„æ™ºèƒ½ä½“æ•°é‡ï¼ˆè™šæ‹Ÿæ»šåŠ¨æ¦‚å¿µï¼‰
            const maxDisplayItems = 100;
            const displayAgents = agents.slice(0, maxDisplayItems);
            
            displayAgents.forEach(agent => {
                let agentItem = agentListCache.get(agent.id);
                
                if (!agentItem) {
                    // åˆ›å»ºæ–°çš„æ™ºèƒ½ä½“é¡¹ç›®
                    agentItem = document.createElement('div');
                    agentItem.className = 'agent-item';
                    agentItem.dataset.agentId = agent.id;
                    
                    agentItem.addEventListener('click', function() {
                        selectAgent(agent);
                    });
                    
                    agentListCache.set(agent.id, agentItem);
                } else {
                    existingItems.delete(agent.id);
                }
                
                // æ›´æ–°å†…å®¹ï¼ˆåªåœ¨å¿…è¦æ—¶ï¼‰
                const newContent = `
                    <div>
                        <strong>${agent.id}</strong>
                        <span class="agent-type ${agent.typeClass}">${agent.typeName}</span>
                    </div>
                    <small>èµ„æº: ${agent.resources} | é£é™©: ${agent.risk.toFixed(2)}</small>
                `;
                
                if (agentItem.innerHTML !== newContent) {
                    agentItem.innerHTML = newContent;
                }
                
                fragment.appendChild(agentItem);
            });
            
            // æ¸…ç†ä¸å†éœ€è¦çš„ç¼“å­˜é¡¹ç›®
            existingItems.forEach(agentId => {
                agentListCache.delete(agentId);
            });
            
            // æ‰¹é‡æ·»åŠ åˆ°DOM
            agentList.appendChild(fragment);
            
            // å¦‚æœæ™ºèƒ½ä½“æ•°é‡è¶…è¿‡æ˜¾ç¤ºé™åˆ¶ï¼Œæ˜¾ç¤ºæç¤º
            if (agents.length > maxDisplayItems) {
                const moreInfo = document.createElement('div');
                moreInfo.className = 'agent-item-info';
                moreInfo.innerHTML = `<small>è¿˜æœ‰ ${agents.length - maxDisplayItems} ä¸ªæ™ºèƒ½ä½“æœªæ˜¾ç¤º</small>`;
                agentList.appendChild(moreInfo);
            }
        }
        
        // é€‰æ‹©æ™ºèƒ½ä½“
        function selectAgent(agent) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.agent-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©æ–°çš„æ™ºèƒ½ä½“
            event.currentTarget.classList.add('selected');
            selectedAgent = agent;
            
            // åœ¨åœ°å›¾ä¸Šé«˜äº®æ˜¾ç¤º
            map.setView([agent.position.lat, agent.position.lng], 15);
            
            // æ˜¾ç¤ºæ™ºèƒ½ä½“è¯¦æƒ…é¢æ¿
            showAgentDetails(agent);
        }
        
        // æ˜¾ç¤ºæ™ºèƒ½ä½“è¯¦æƒ…
        function showAgentDetails(agent) {
            document.getElementById('agentDetailsPanel').style.display = 'block';
            document.getElementById('detailAgentId').textContent = agent.id;
            document.getElementById('detailAgentType').textContent = agent.typeName;
            document.getElementById('detailAgentPosition').textContent = `${agent.position.lat.toFixed(4)}, ${agent.position.lng.toFixed(4)}`;
            document.getElementById('detailAgentResources').value = agent.resources;
            document.getElementById('detailResourcesValue').textContent = agent.resources;
            document.getElementById('detailAgentRisk').textContent = agent.risk.toFixed(2);
            document.getElementById('detailAgentStatus').textContent = agent.status;
        }
        
        // å…³é—­æ™ºèƒ½ä½“è¯¦æƒ…é¢æ¿
        function closeAgentDetails() {
            document.getElementById('agentDetailsPanel').style.display = 'none';
            selectedAgent = null;
            // æ¸…é™¤é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.agent-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        // æ›´æ–°æ™ºèƒ½ä½“èµ„æº
        function updateAgentResources() {
            if (!selectedAgent) return;
            
            const newResources = parseInt(document.getElementById('detailAgentResources').value);
            document.getElementById('detailResourcesValue').textContent = newResources;
            selectedAgent.resources = newResources;
            
            // å‘é€æ›´æ–°åˆ°åç«¯
            sendCommand('update_agent', {
                agentId: selectedAgent.id,
                property: 'resources',
                value: newResources
            });
            
            // æ›´æ–°æ™ºèƒ½ä½“åˆ—è¡¨æ˜¾ç¤º
            updateAgentList();
        }
        
        // æ™ºèƒ½ä½“è¡Œä¸ºå¹²é¢„
        function interventeAgent(action) {
            if (!selectedAgent) return;
            
            sendCommand('intervene_agent', {
                agentId: selectedAgent.id,
                action: action
            });
            
            // æ˜¾ç¤ºå¹²é¢„åé¦ˆ
            const actionNames = {
                'move_to_safety': 'å¼•å¯¼è‡³å®‰å…¨åŒº',
                'increase_caution': 'æé«˜è­¦è§‰æ€§',
                'help_others': 'ååŠ©ä»–äºº',
                'share_info': 'åˆ†äº«ä¿¡æ¯',
                'reset_behavior': 'é‡ç½®è¡Œä¸º'
            };
            
            alert(`å·²å¯¹æ™ºèƒ½ä½“ ${selectedAgent.id} æ‰§è¡Œå¹²é¢„ï¼š${actionNames[action]}`);
        }
        
        // ä»¿çœŸæ§åˆ¶å‡½æ•°
        function startSimulation() {
            simulationState = 'running';
            updateSimulationStatus();
            sendCommand('start');
        }
        
        function pauseSimulation() {
            simulationState = 'paused';
            updateSimulationStatus();
            sendCommand('pause');
        }
        
        function stopSimulation() {
            simulationState = 'stopped';
            currentStep = 0;
            updateSimulationStatus();
            sendCommand('stop');
        }
        
        function resetSimulation() {
            simulationState = 'stopped';
            currentStep = 0;
            updateSimulationStatus();
            sendCommand('reset');
            generateSampleAgents();
        }
        
        // æ›´æ–°ä»¿çœŸçŠ¶æ€æ˜¾ç¤º
        function updateSimulationStatus() {
            const statusIndicator = document.getElementById('simStatus');
            const statusText = document.getElementById('simStatusText');
            
            statusIndicator.className = 'status-indicator';
            
            switch(simulationState) {
                case 'running':
                    statusIndicator.classList.add('status-running');
                    statusText.textContent = 'ä»¿çœŸè¿è¡Œä¸­';
                    break;
                case 'paused':
                    statusIndicator.classList.add('status-paused');
                    statusText.textContent = 'ä»¿çœŸå·²æš‚åœ';
                    break;
                case 'stopped':
                    statusIndicator.classList.add('status-stopped');
                    statusText.textContent = 'ä»¿çœŸå·²åœæ­¢';
                    break;
            }
        }
        
        // å‘é€å‘½ä»¤åˆ°åç«¯
        function sendCommand(command, data = {}) {
            if (ws && ws.connected) {
                ws.emit('command', {
                    command: command,
                    data: data
                });
            }
        }
        
        // å¤„ç†ä»¿çœŸæ›´æ–°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 100; // é™åˆ¶æ›´æ–°é¢‘ç‡ä¸º100ms
        
        function handleSimulationUpdate(data) {
            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_INTERVAL) {
                return; // è·³è¿‡è¿‡äºé¢‘ç¹çš„æ›´æ–°
            }
            lastUpdateTime = now;
            
            if (data.type === 'step_update') {
                currentStep = data.step;
                
                // æ‰¹é‡æ›´æ–°DOMå…ƒç´ 
                const updates = {
                    'stepCount': currentStep,
                    'timeDisplay': `æ—¶é—´: ${formatTime(currentStep)}`,
                    'activeAgents': data.activeAgents || 0,
                    'evacuatedCount': data.evacuatedCount || 0,
                    'helpActions': data.helpActions || 0
                };
                
                // ä½¿ç”¨DocumentFragmentæ‰¹é‡æ›´æ–°DOM
                Object.entries(updates).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element && element.textContent !== String(value)) {
                        element.textContent = value;
                    }
                });
                
                // èŠ‚æµå›¾è¡¨æ›´æ–°
                if (data.behaviorStats || data.riskStats) {
                    debouncedChartUpdate(data);
                }
                
                // æ›´æ–°æ™ºèƒ½ä½“æ˜¾ç¤ºï¼ˆå¦‚æœæœ‰æ™ºèƒ½ä½“æ•°æ®ï¼‰
                if (data.agents) {
                    agents = data.agents;
                    queueUpdate('agent');
                    queueUpdate('map');
                }
                
                // æ›´æ–°æ´ªæ°´è”“å»¶å¯è§†åŒ–
                if (data.floodData) {
                    updateFloodVisualization(data.floodData);
                }
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(steps) {
            const hours = Math.floor(steps / 3600);
            const minutes = Math.floor((steps % 3600) / 60);
            const seconds = steps % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ä¼˜åŒ–çš„å›¾è¡¨æ›´æ–°å‡½æ•°
        let chartUpdateQueue = [];
        let isUpdatingCharts = false;
        
        // é˜²æŠ–çš„å›¾è¡¨æ›´æ–°
        const debouncedChartUpdate = debounce(function(data) {
            chartUpdateQueue.push(data);
            processChartUpdates();
        }, 200);
        
        function processChartUpdates() {
            if (isUpdatingCharts || chartUpdateQueue.length === 0) return;
            
            isUpdatingCharts = true;
            requestAnimationFrame(() => {
                const latestData = chartUpdateQueue[chartUpdateQueue.length - 1];
                chartUpdateQueue = [];
                
                updateChartsWithData(latestData);
                isUpdatingCharts = false;
            });
        }
        
        function updateCharts() {
            if (!charts || !charts.population || !charts.population.data) {
                return; // å›¾è¡¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ›´æ–°
            }
            
            const typeCounts = [0, 0, 0];
            agents.forEach(agent => {
                switch(agent.type) {
                    case 'family': typeCounts[0]++; break;
                    case 'community': typeCounts[1]++; break;
                    case 'universal': typeCounts[2]++; break;
                }
            });
            
            // åªåœ¨æ•°æ®çœŸæ­£æ”¹å˜æ—¶æ›´æ–°
            const currentData = charts.population.data.datasets[0].data;
            if (JSON.stringify(currentData) !== JSON.stringify(typeCounts)) {
                charts.population.data.datasets[0].data = typeCounts;
                charts.population.update('none'); // ç¦ç”¨åŠ¨ç”»ä»¥æé«˜æ€§èƒ½
            }
        }
        
        function updateChartsWithData(data) {
            try {
                // æ›´æ–°è¡Œä¸ºç»Ÿè®¡å›¾è¡¨
                if (data.behaviorStats && charts.behavior) {
                    const labels = charts.behavior.data.labels;
                    const helpData = charts.behavior.data.datasets[0].data;
                    const evacuationData = charts.behavior.data.datasets[1].data;
                    
                    labels.push(currentStep);
                    helpData.push(data.behaviorStats.helpActions || 0);
                    evacuationData.push(data.behaviorStats.evacuations || 0);
                    
                    // ä¿æŒæœ€è¿‘50ä¸ªæ•°æ®ç‚¹
                    if (labels.length > 50) {
                        labels.shift();
                        helpData.shift();
                        evacuationData.shift();
                    }
                    
                    charts.behavior.update('none'); // ç¦ç”¨åŠ¨ç”»
                }
                
                // æ›´æ–°é£é™©åˆ†å¸ƒå›¾è¡¨
                if (data.riskStats && charts.risk) {
                    const newData = [
                        data.riskStats.low || 0,
                        data.riskStats.medium || 0,
                        data.riskStats.high || 0
                    ];
                    
                    // åªåœ¨æ•°æ®æ”¹å˜æ—¶æ›´æ–°
                    const currentData = charts.risk.data.datasets[0].data;
                    if (JSON.stringify(currentData) !== JSON.stringify(newData)) {
                        charts.risk.data.datasets[0].data = newData;
                        charts.risk.update('none'); // ç¦ç”¨åŠ¨ç”»
                    }
                }
            } catch (error) {
                console.warn('å›¾è¡¨æ›´æ–°é”™è¯¯:', error);
            }
        }
        
        // åœºæ™¯ç¼–è¾‘åŠŸèƒ½
        let editMode = null;
        let isDrawing = false;
        let currentDrawingLayer = null;
        let drawingPoints = [];
        let scenarioLayers = {
            floodZones: [],
            safeZones: [],
            barriers: []
        };
        
        // æ´ªæ°´å¯è§†åŒ–å˜é‡
        let floodLayers = [];
        let floodAnimationId = null;
        let floodIntensityData = new Map();
        let floodSpreadAnimation = null;
        
        // æ´ªæ°´å¯è§†åŒ–é…ç½®
        const floodConfig = {
            colors: {
                low: '#e3f2fd',      // æµ…è“è‰²
                medium: '#2196f3',   // è“è‰²
                high: '#1565c0',     // æ·±è“è‰²
                critical: '#0d47a1'  // ææ·±è“è‰²
            },
            opacities: {
                low: 0.3,
                medium: 0.5,
                high: 0.7,
                critical: 0.9
            },
            animationDuration: 2000,
            pulseInterval: 1500,
            // æ–°å¢æ´ªæ°´è·¯å¾„é…ç½®
            pathConfig: {
                width: 8,
                arrowSize: 15,
                flowSpeed: 2000,
                pathOpacity: 0.8
            },
            // åœ°å½¢æ¨¡æ‹Ÿé…ç½®
            terrainConfig: {
                elevationLevels: 5,
                slopeThreshold: 0.1,
                riverWidth: 20
            }
        };
        
        // æ´ªæ°´è·¯å¾„å’Œæµå‘æ•°æ®
        let floodPaths = [];
        let flowDirections = new Map();
        let terrainData = new Map();
        
        function addFloodZone() {
            exitEditMode(); // å…ˆé€€å‡ºä¹‹å‰çš„ç¼–è¾‘æ¨¡å¼
            editMode = 'flood';
            isDrawing = false;
            map.getContainer().style.cursor = 'crosshair';
            showEditingHint('ç‚¹å‡»åœ°å›¾å¼€å§‹ç»˜åˆ¶æ´ªæ°´åŒºåŸŸï¼Œå†æ¬¡ç‚¹å‡»å®Œæˆç»˜åˆ¶');
            
            // æ·»åŠ ç»˜åˆ¶äº‹ä»¶ç›‘å¬
            map.on('click', handleFloodDrawing);
            map.on('contextmenu', cancelDrawing);
        }
        
        function addSafeZone() {
            exitEditMode(); // å…ˆé€€å‡ºä¹‹å‰çš„ç¼–è¾‘æ¨¡å¼
            editMode = 'safe';
            isDrawing = false;
            map.getContainer().style.cursor = 'crosshair';
            showEditingHint('ç‚¹å‡»åœ°å›¾å¼€å§‹ç»˜åˆ¶å®‰å…¨åŒºåŸŸï¼Œå†æ¬¡ç‚¹å‡»å®Œæˆç»˜åˆ¶');
            
            // æ·»åŠ ç»˜åˆ¶äº‹ä»¶ç›‘å¬
            map.on('click', handleSafeZoneDrawing);
            map.on('contextmenu', cancelDrawing);
        }
        
        function addBarrier() {
            exitEditMode(); // å…ˆé€€å‡ºä¹‹å‰çš„ç¼–è¾‘æ¨¡å¼
            editMode = 'barrier';
            map.getContainer().style.cursor = 'crosshair';
            showEditingHint('ç‚¹å‡»åœ°å›¾æ·»åŠ é“è·¯é˜»å¡ç‚¹');
            
            // æ·»åŠ ç»˜åˆ¶äº‹ä»¶ç›‘å¬
            map.on('click', handleBarrierDrawing);
            map.on('contextmenu', cancelDrawing);
        }
        
        function clearScenario() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åœºæ™¯è®¾ç½®å—ï¼Ÿ')) {
                // æ¸…é™¤æ‰€æœ‰åœºæ™¯å›¾å±‚
                Object.values(scenarioLayers).forEach(layerArray => {
                    layerArray.forEach(layer => map.removeLayer(layer));
                });
                scenarioLayers = {
                    floodZones: [],
                    safeZones: [],
                    barriers: []
                };
                editMode = null;
                map.getContainer().style.cursor = '';
                hideEditingHint();
                sendCommand('clear_scenario');
            }
        }
        
        function showEditingHint(message) {
            let hint = document.getElementById('editingHint');
            if (!hint) {
                hint = document.createElement('div');
                hint.id = 'editingHint';
                hint.style.cssText = `
                    position: absolute;
                    top: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 1001;
                    font-size: 14px;
                `;
                document.querySelector('.simulation-map').appendChild(hint);
            }
            hint.textContent = message;
            hint.style.display = 'block';
        }
        
        function hideEditingHint() {
            const hint = document.getElementById('editingHint');
            if (hint) {
                hint.style.display = 'none';
            }
        }
        
        function handleMapClick(e) {
            if (!editMode) return;
            
            switch(editMode) {
                case 'flood':
                    handleFloodDrawing(e);
                    break;
                case 'safe':
                    handleSafeZoneDrawing(e);
                    break;
                case 'barrier':
                    handleBarrierDrawing(e);
                    break;
            }
        }
        
        // æ´ªæ°´åŒºåŸŸç»˜åˆ¶å¤„ç†
        function handleFloodDrawing(e) {
            const latlng = e.latlng;
            
            if (!isDrawing) {
                // å¼€å§‹ç»˜åˆ¶
                isDrawing = true;
                drawingPoints = [latlng];
                
                // åˆ›å»ºä¸´æ—¶åœ†å½¢é¢„è§ˆ
                currentDrawingLayer = L.circle(latlng, {
                    radius: 100,
                    color: '#ff4444',
                    fillColor: '#ff4444',
                    fillOpacity: 0.2,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
                
                showEditingHint('ç§»åŠ¨é¼ æ ‡è°ƒæ•´å¤§å°ï¼Œå†æ¬¡ç‚¹å‡»ç¡®è®¤æ´ªæ°´åŒºåŸŸ');
                map.on('mousemove', updateFloodPreview);
            } else {
                // å®Œæˆç»˜åˆ¶
                finishFloodDrawing(latlng);
            }
        }
        
        function updateFloodPreview(e) {
            if (!isDrawing || !currentDrawingLayer) return;
            
            const startPoint = drawingPoints[0];
            const currentPoint = e.latlng;
            const radius = Math.max(50, Math.min(500, startPoint.distanceTo(currentPoint)));
            
            currentDrawingLayer.setRadius(radius);
        }
        
        function finishFloodDrawing(latlng) {
            if (!currentDrawingLayer) return;
            
            const startPoint = drawingPoints[0];
            const radius = Math.max(100, Math.min(500, startPoint.distanceTo(latlng)));
            
            // ç§»é™¤ä¸´æ—¶é¢„è§ˆ
            map.removeLayer(currentDrawingLayer);
            map.off('mousemove', updateFloodPreview);
            
            // åˆ›å»ºæœ€ç»ˆçš„æ´ªæ°´åŒºåŸŸ
            const floodZone = L.circle(startPoint, {
                radius: radius,
                color: '#ff4444',
                fillColor: '#ff4444',
                fillOpacity: 0.4,
                weight: 3
            }).addTo(map);
            
            floodZone.bindPopup(`<div class="scenario-popup"><h6><i class="fas fa-water"></i> æ´ªæ°´åŒºåŸŸ</h6><p>åŠå¾„: ${Math.round(radius)}ç±³</p><button class="btn btn-sm btn-danger" onclick="removeScenarioLayer(this, 'flood')">åˆ é™¤</button></div>`);
            
            scenarioLayers.floodZones.push(floodZone);
            
            sendCommand('add_flood_zone', {
                lat: startPoint.lat,
                lng: startPoint.lng,
                radius: radius
            });
            
            // é‡ç½®ç»˜åˆ¶çŠ¶æ€
            resetDrawingState();
            showEditingHint('æ´ªæ°´åŒºåŸŸå·²åˆ›å»ºï¼ç»§ç»­ç‚¹å‡»åˆ›å»ºæ›´å¤šåŒºåŸŸï¼Œæˆ–å³é”®é€€å‡ºç¼–è¾‘æ¨¡å¼');
        }
        
        // å®‰å…¨åŒºåŸŸç»˜åˆ¶å¤„ç†
        function handleSafeZoneDrawing(e) {
            const latlng = e.latlng;
            
            if (!isDrawing) {
                // å¼€å§‹ç»˜åˆ¶
                isDrawing = true;
                drawingPoints = [latlng];
                
                // åˆ›å»ºä¸´æ—¶åœ†å½¢é¢„è§ˆ
                currentDrawingLayer = L.circle(latlng, {
                    radius: 100,
                    color: '#44ff44',
                    fillColor: '#44ff44',
                    fillOpacity: 0.2,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
                
                showEditingHint('ç§»åŠ¨é¼ æ ‡è°ƒæ•´å¤§å°ï¼Œå†æ¬¡ç‚¹å‡»ç¡®è®¤å®‰å…¨åŒºåŸŸ');
                map.on('mousemove', updateSafeZonePreview);
            } else {
                // å®Œæˆç»˜åˆ¶
                finishSafeZoneDrawing(latlng);
            }
        }
        
        function updateSafeZonePreview(e) {
            if (!isDrawing || !currentDrawingLayer) return;
            
            const startPoint = drawingPoints[0];
            const currentPoint = e.latlng;
            const radius = Math.max(50, Math.min(400, startPoint.distanceTo(currentPoint)));
            
            currentDrawingLayer.setRadius(radius);
        }
        
        function finishSafeZoneDrawing(latlng) {
            if (!currentDrawingLayer) return;
            
            const startPoint = drawingPoints[0];
            const radius = Math.max(80, Math.min(400, startPoint.distanceTo(latlng)));
            
            // ç§»é™¤ä¸´æ—¶é¢„è§ˆ
            map.removeLayer(currentDrawingLayer);
            map.off('mousemove', updateSafeZonePreview);
            
            // åˆ›å»ºæœ€ç»ˆçš„å®‰å…¨åŒºåŸŸ
            const safeZone = L.circle(startPoint, {
                radius: radius,
                color: '#44ff44',
                fillColor: '#44ff44',
                fillOpacity: 0.4,
                weight: 3
            }).addTo(map);
            
            safeZone.bindPopup(`<div class="scenario-popup"><h6><i class="fas fa-shield-alt"></i> å®‰å…¨åŒºåŸŸ</h6><p>åŠå¾„: ${Math.round(radius)}ç±³</p><p>å®¹é‡: ${Math.round(radius / 10)}äºº</p><button class="btn btn-sm btn-danger" onclick="removeScenarioLayer(this, 'safe')">åˆ é™¤</button></div>`);
            
            scenarioLayers.safeZones.push(safeZone);
            
            sendCommand('add_safe_zone', {
                lat: startPoint.lat,
                lng: startPoint.lng,
                radius: radius
            });
            
            // é‡ç½®ç»˜åˆ¶çŠ¶æ€
            resetDrawingState();
            showEditingHint('å®‰å…¨åŒºåŸŸå·²åˆ›å»ºï¼ç»§ç»­ç‚¹å‡»åˆ›å»ºæ›´å¤šåŒºåŸŸï¼Œæˆ–å³é”®é€€å‡ºç¼–è¾‘æ¨¡å¼');
        }
        
        // éšœç¢ç‰©ç»˜åˆ¶å¤„ç†
        function handleBarrierDrawing(e) {
            const latlng = e.latlng;
            
            const barrier = L.circleMarker(latlng, {
                radius: 12,
                color: '#ffaa00',
                fillColor: '#ffaa00',
                fillOpacity: 0.8,
                weight: 3
            }).addTo(map);
            
            barrier.bindPopup(`<div class="scenario-popup"><h6><i class="fas fa-road"></i> é“è·¯é˜»å¡</h6><p>ç±»å‹: éšœç¢ç‰©</p><button class="btn btn-sm btn-danger" onclick="removeScenarioLayer(this, 'barrier')">åˆ é™¤</button></div>`);
            
            scenarioLayers.barriers.push(barrier);
            
            sendCommand('add_barrier', {
                lat: latlng.lat,
                lng: latlng.lng
            });
            
            showEditingHint('éšœç¢ç‰©å·²æ·»åŠ ï¼ç»§ç»­ç‚¹å‡»æ·»åŠ æ›´å¤šéšœç¢ç‰©ï¼Œæˆ–å³é”®é€€å‡ºç¼–è¾‘æ¨¡å¼');
        }
        
        // é‡ç½®ç»˜åˆ¶çŠ¶æ€
        function resetDrawingState() {
            isDrawing = false;
            currentDrawingLayer = null;
            drawingPoints = [];
            map.off('mousemove', updateFloodPreview);
            map.off('mousemove', updateSafeZonePreview);
        }
        
        // å–æ¶ˆç»˜åˆ¶
        function cancelDrawing(e) {
            e.preventDefault();
            
            if (currentDrawingLayer) {
                map.removeLayer(currentDrawingLayer);
            }
            
            resetDrawingState();
            exitEditMode();
        }
        
        // æ´ªæ°´å¯è§†åŒ–å‡½æ•°
        function updateFloodVisualization(floodData) {
            if (!floodData || !Array.isArray(floodData)) {
                return;
            }
            
            // æ¸…é™¤æ—§çš„æ´ªæ°´å±‚
            clearFloodLayers();
            
            // å¤„ç†æ´ªæ°´æ•°æ®å¹¶åˆ›å»ºæ–°çš„å¯è§†åŒ–å±‚
            floodData.forEach(floodPoint => {
                createFloodLayer(floodPoint);
            });
            
            // å¯åŠ¨æ´ªæ°´æ‰©æ•£åŠ¨ç”»
            startFloodSpreadAnimation();
        }
        
        function createFloodLayer(floodPoint) {
            const { lat, lng, intensity, radius } = floodPoint;
            
            // æ ¹æ®å¼ºåº¦ç¡®å®šé¢œè‰²å’Œé€æ˜åº¦
            const level = getFloodLevel(intensity);
            const color = floodConfig.colors[level];
            const opacity = floodConfig.opacities[level];
            
            // åˆ›å»ºæ´ªæ°´åœ†åœˆ
            const floodCircle = L.circle([lat, lng], {
                radius: radius || 100,
                fillColor: color,
                color: color,
                weight: 2,
                opacity: 0.8,
                fillOpacity: opacity,
                className: 'flood-layer flood-level-' + level
            }).addTo(map);
            
            // æ·»åŠ è„‰å†²æ•ˆæœ
            addFloodPulseEffect(floodCircle, level);
            
            // ç”Ÿæˆæ´ªæ°´è·¯å¾„
            generateFloodPaths(lat, lng, intensity, radius);
            
            // å­˜å‚¨æ´ªæ°´å±‚
            floodLayers.push(floodCircle);
            
            // æ›´æ–°å¼ºåº¦æ•°æ®
            const key = `${lat.toFixed(6)},${lng.toFixed(6)}`;
            floodIntensityData.set(key, { intensity, level, circle: floodCircle });
        }
        
        // ç”Ÿæˆæ´ªæ°´è·¯å¾„
        function generateFloodPaths(centerLat, centerLng, intensity, radius) {
            const pathCount = Math.floor(intensity * 8) + 4; // æ ¹æ®å¼ºåº¦ç¡®å®šè·¯å¾„æ•°é‡
            const radiusKm = (radius || 100) / 1000; // è½¬æ¢ä¸ºå…¬é‡Œ
            
            for (let i = 0; i < pathCount; i++) {
                const angle = (360 / pathCount) * i;
                const path = generateSingleFloodPath(centerLat, centerLng, angle, radiusKm, intensity);
                if (path && path.length > 1) {
                    createFloodPathVisualization(path, intensity);
                    floodPaths.push(path);
                }
            }
        }
        
        // ç”Ÿæˆå•æ¡æ´ªæ°´è·¯å¾„
        function generateSingleFloodPath(startLat, startLng, angle, maxDistance, intensity) {
            const path = [[startLat, startLng]];
            let currentLat = startLat;
            let currentLng = startLng;
            let currentDistance = 0;
            const stepSize = 0.001; // çº¦100ç±³
            
            // æ¨¡æ‹Ÿåœ°å½¢å½±å“çš„è·¯å¾„ç”Ÿæˆ
            while (currentDistance < maxDistance) {
                // åŸºç¡€æ–¹å‘ï¼ˆè€ƒè™‘åœ°å½¢å¡åº¦ï¼‰
                let directionAngle = angle + getTerrainInfluence(currentLat, currentLng);
                
                // æ·»åŠ éšæœºæ‰°åŠ¨æ¨¡æ‹Ÿè‡ªç„¶æ°´æµ
                directionAngle += (Math.random() - 0.5) * 30;
                
                // è®¡ç®—ä¸‹ä¸€ä¸ªç‚¹
                const deltaLat = stepSize * Math.cos(directionAngle * Math.PI / 180);
                const deltaLng = stepSize * Math.sin(directionAngle * Math.PI / 180);
                
                currentLat += deltaLat;
                currentLng += deltaLng;
                currentDistance += stepSize;
                
                // æ£€æŸ¥æ˜¯å¦é‡åˆ°éšœç¢ç‰©æˆ–åœ°å½¢å˜åŒ–
                if (!isValidFloodPath(currentLat, currentLng)) {
                    break;
                }
                
                path.push([currentLat, currentLng]);
                
                // å¼ºåº¦è¡°å‡
                if (Math.random() < 0.1 * (1 - intensity)) {
                    break;
                }
            }
            
            return path;
        }
        
        // è·å–åœ°å½¢å½±å“ï¼ˆæ¨¡æ‹Ÿå¡åº¦å’Œé«˜ç¨‹ï¼‰
        function getTerrainInfluence(lat, lng) {
            const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
            if (!terrainData.has(key)) {
                // æ¨¡æ‹Ÿåœ°å½¢æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä»DEMæ•°æ®è·å–ï¼‰
                const elevation = Math.sin(lat * 100) * Math.cos(lng * 100) * 50;
                const slope = Math.random() * 10 - 5; // -5åˆ°5åº¦çš„å¡åº¦
                terrainData.set(key, { elevation, slope });
            }
            
            const terrain = terrainData.get(key);
            return terrain.slope * 2; // å¡åº¦å½±å“æµå‘
        }
        
        // æ£€æŸ¥è·¯å¾„æœ‰æ•ˆæ€§
        function isValidFloodPath(lat, lng) {
            // æ£€æŸ¥æ˜¯å¦åœ¨åœ°å›¾è¾¹ç•Œå†…
            const bounds = map.getBounds();
            if (lat < bounds.getSouth() || lat > bounds.getNorth() || 
                lng < bounds.getWest() || lng > bounds.getEast()) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦é‡åˆ°éšœç¢ç‰©
            if (simulation_state.scenario && simulation_state.scenario.barriers) {
                for (const barrier of simulation_state.scenario.barriers) {
                    const distance = getDistance(lat, lng, barrier.lat, barrier.lng);
                    if (distance < 0.0005) { // çº¦50ç±³
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        function getFloodLevel(intensity) {
            if (intensity >= 0.8) return 'critical';
            if (intensity >= 0.6) return 'high';
            if (intensity >= 0.3) return 'medium';
            return 'low';
        }
        
        function addFloodPulseEffect(circle, level) {
            let pulseRadius = circle.getRadius();
            let growing = true;
            const baseRadius = pulseRadius;
            const maxRadius = baseRadius * 1.3;
            const minRadius = baseRadius * 0.8;
            let opacity = floodConfig.opacities[level];
            let colorIntensity = 0;
            
            const pulse = () => {
                if (growing) {
                    pulseRadius += 2;
                    opacity += 0.02;
                    colorIntensity += 0.1;
                    if (pulseRadius >= maxRadius) {
                        growing = false;
                    }
                } else {
                    pulseRadius -= 2;
                    opacity -= 0.02;
                    colorIntensity -= 0.1;
                    if (pulseRadius <= minRadius) {
                        growing = true;
                    }
                }
                
                // åŠ¨æ€é¢œè‰²å˜åŒ–
                const baseColor = floodConfig.colors[level];
                const dynamicColor = adjustColorIntensity(baseColor, colorIntensity);
                
                circle.setRadius(pulseRadius);
                circle.setStyle({
                    fillOpacity: Math.max(0.1, Math.min(1, opacity)),
                    color: dynamicColor,
                    fillColor: dynamicColor
                });
                
                // æ·»åŠ æ³¢çº¹æ•ˆæœ
                if (Math.random() < 0.05) {
                    createWaveRipple(circle.getLatLng(), baseRadius, level);
                }
            };
            
            // æ ¹æ®æ´ªæ°´ç­‰çº§è°ƒæ•´è„‰å†²é¢‘ç‡
            const interval = level === 'critical' ? 80 : 
                           level === 'high' ? 120 : 
                           level === 'medium' ? 160 : 250;
            
            const pulseInterval = setInterval(pulse, interval);
            
            // å­˜å‚¨intervalä»¥ä¾¿åç»­æ¸…ç†
            circle._pulseInterval = pulseInterval;
        }
        
        // è°ƒæ•´é¢œè‰²å¼ºåº¦
        function adjustColorIntensity(hexColor, intensity) {
            // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºRGB
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            
            // è°ƒæ•´äº®åº¦
            const factor = 1 + intensity * 0.3;
            const newR = Math.min(255, Math.max(0, Math.floor(r * factor)));
            const newG = Math.min(255, Math.max(0, Math.floor(g * factor)));
            const newB = Math.min(255, Math.max(0, Math.floor(b * factor)));
            
            return `rgb(${newR}, ${newG}, ${newB})`;
        }
        
        // åˆ›å»ºæ³¢çº¹æ•ˆæœ
        function createWaveRipple(center, baseRadius, level) {
            const ripple = L.circle(center, {
                radius: baseRadius * 0.5,
                fillColor: 'transparent',
                color: floodConfig.colors[level],
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0
            }).addTo(map);
            
            let currentRadius = baseRadius * 0.5;
            const maxRadius = baseRadius * 2;
            let opacity = 0.8;
            
            const animate = () => {
                currentRadius += baseRadius * 0.1;
                opacity -= 0.04;
                
                ripple.setRadius(currentRadius);
                ripple.setStyle({ opacity: Math.max(0, opacity) });
                
                if (currentRadius < maxRadius && opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    map.removeLayer(ripple);
                }
            };
            
            requestAnimationFrame(animate);
        }
        
        function startFloodSpreadAnimation() {
            if (floodSpreadAnimation) {
                clearInterval(floodSpreadAnimation);
            }
            
            let animationStep = 0;
            const maxSteps = 20;
            
            floodSpreadAnimation = setInterval(() => {
                animationStep++;
                
                // æ›´æ–°æ´ªæ°´å±‚çš„åŠ¨ç”»æ•ˆæœ
                floodLayers.forEach((layer, index) => {
                    const delay = index * 100; // é”™å¼€åŠ¨ç”»æ—¶é—´
                    
                    setTimeout(() => {
                        // æ·»åŠ æ³¢çº¹æ•ˆæœ
                        addRippleEffect(layer);
                    }, delay);
                });
                
                if (animationStep >= maxSteps) {
                    clearInterval(floodSpreadAnimation);
                    floodSpreadAnimation = null;
                }
            }, 200);
        }
        
        function addRippleEffect(layer) {
            const center = layer.getLatLng();
            const baseRadius = layer.getRadius();
            
            // åˆ›å»ºæ³¢çº¹åœ†åœˆ
            const ripple = L.circle(center, {
                radius: baseRadius,
                fillColor: 'transparent',
                color: '#2196f3',
                weight: 3,
                opacity: 0.8,
                fillOpacity: 0
            }).addTo(map);
            
            // æ³¢çº¹æ‰©æ•£åŠ¨ç”»
            let currentRadius = baseRadius;
            const maxRadius = baseRadius * 2;
            let opacity = 0.8;
            
            const animate = () => {
                currentRadius += 10;
                opacity -= 0.05;
                
                ripple.setRadius(currentRadius);
                ripple.setStyle({ opacity: Math.max(0, opacity) });
                
                if (currentRadius < maxRadius && opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    map.removeLayer(ripple);
                }
            };
            
            requestAnimationFrame(animate);
        }
        
        // åˆ›å»ºæ´ªæ°´è·¯å¾„å¯è§†åŒ–
        function createFloodPathVisualization(path, intensity) {
            if (path.length < 2) return;
            
            const level = getFloodLevel(intensity);
            const color = floodConfig.colors[level];
            const pathWidth = floodConfig.pathConfig.width * intensity;
            
            // åˆ›å»ºè·¯å¾„çº¿
            const pathLine = L.polyline(path, {
                color: color,
                weight: pathWidth,
                opacity: floodConfig.pathConfig.pathOpacity,
                className: 'flood-path flood-level-' + level
            }).addTo(map);
            
            // æ·»åŠ æµå‘ç®­å¤´
            addFlowArrows(path, color, intensity);
            
            // æ·»åŠ æµåŠ¨åŠ¨ç”»
            addFlowAnimation(pathLine, intensity);
            
            floodLayers.push(pathLine);
        }
        
        // æ·»åŠ æµå‘ç®­å¤´
        function addFlowArrows(path, color, intensity) {
            const arrowInterval = Math.max(3, Math.floor(path.length / 8)); // ç®­å¤´é—´éš”
            const arrowSize = floodConfig.pathConfig.arrowSize * intensity;
            
            for (let i = arrowInterval; i < path.length; i += arrowInterval) {
                const currentPoint = path[i];
                const prevPoint = path[i - 1];
                
                // è®¡ç®—ç®­å¤´æ–¹å‘
                const angle = Math.atan2(
                    currentPoint[1] - prevPoint[1],
                    currentPoint[0] - prevPoint[0]
                ) * 180 / Math.PI;
                
                // åˆ›å»ºç®­å¤´æ ‡è®°
                const arrowIcon = L.divIcon({
                    html: `<div class="flood-arrow" style="
                        width: ${arrowSize}px;
                        height: ${arrowSize}px;
                        background-color: ${color};
                        transform: rotate(${angle + 90}deg);
                        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
                        opacity: 0.8;
                    "></div>`,
                    className: 'flood-arrow-marker',
                    iconSize: [arrowSize, arrowSize],
                    iconAnchor: [arrowSize/2, arrowSize/2]
                });
                
                const arrowMarker = L.marker(currentPoint, {
                    icon: arrowIcon,
                    interactive: false
                }).addTo(map);
                
                floodLayers.push(arrowMarker);
            }
        }
        
        // æ·»åŠ æµåŠ¨åŠ¨ç”»
        function addFlowAnimation(pathLine, intensity) {
            const flowSpeed = floodConfig.pathConfig.flowSpeed / intensity;
            let animationOffset = 0;
            
            const animateFlow = () => {
                animationOffset += 5;
                if (animationOffset > 100) animationOffset = 0;
                
                // æ›´æ–°è·¯å¾„æ ·å¼ä»¥æ˜¾ç¤ºæµåŠ¨æ•ˆæœ
                const element = pathLine.getElement();
                if (element) {
                    element.style.strokeDasharray = '10 10';
                    element.style.strokeDashoffset = -animationOffset;
                }
            };
            
            pathLine.flowAnimation = setInterval(animateFlow, 100);
        }
        
        function clearFloodLayers() {
            floodLayers.forEach(layer => {
                // æ¸…ç†è„‰å†²åŠ¨ç”»
                if (layer._pulseInterval) {
                    clearInterval(layer._pulseInterval);
                }
                // æ¸…ç†æµåŠ¨åŠ¨ç”»
                if (layer.flowAnimation) {
                    clearInterval(layer.flowAnimation);
                }
                map.removeLayer(layer);
            });
            floodLayers = [];
            floodPaths = [];
            flowDirections.clear();
            floodIntensityData.clear();
        }
        
        function toggleFloodVisualization() {
            const isVisible = floodLayers.length > 0 && map.hasLayer(floodLayers[0]);
            
            floodLayers.forEach(layer => {
                if (isVisible) {
                    map.removeLayer(layer);
                } else {
                    map.addLayer(layer);
                }
            });
            
            // æ›´æ–°åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            const toggleBtn = document.getElementById('toggleFloodBtn');
            if (toggleBtn) {
                toggleBtn.textContent = isVisible ? 'æ˜¾ç¤ºæ´ªæ°´' : 'éšè—æ´ªæ°´';
                toggleBtn.className = isVisible ? 'btn btn-primary' : 'btn btn-secondary';
            }
        }
        
        function removeScenarioLayer(button, type) {
            const popup = button.closest('.leaflet-popup');
            const layer = popup._source;
            
            map.removeLayer(layer);
            
            // ä»æ•°ç»„ä¸­ç§»é™¤
            const layerArray = scenarioLayers[type + 'Zones'] || scenarioLayers[type + 's'];
            const index = layerArray.indexOf(layer);
            if (index > -1) {
                layerArray.splice(index, 1);
            }
            
            sendCommand('remove_scenario_element', {
                type: type,
                lat: layer.getLatLng().lat,
                lng: layer.getLatLng().lng
            });
        }
        
        function exitEditMode() {
            editMode = null;
            map.getContainer().style.cursor = '';
            hideEditingHint();
        }
        
        function loadScenarioFromData(scenarioData) {
            // æ¸…é™¤ç°æœ‰åœºæ™¯å›¾å±‚
            Object.values(scenarioLayers).forEach(layerArray => {
                layerArray.forEach(layer => map.removeLayer(layer));
            });
            scenarioLayers = {
                floodZones: [],
                safeZones: [],
                barriers: []
            };
            
            // åŠ è½½æ´ªæ°´åŒºåŸŸ
            if (scenarioData.flood_zones) {
                scenarioData.flood_zones.forEach(zone => {
                    // å®‰å…¨æ£€æŸ¥åæ ‡å±æ€§
                    const lat = zone.lat || zone.latitude || 0;
                    const lng = zone.lng || zone.longitude || zone.lon || 0;
                    
                    if (lat && lng) {
                        const floodZone = L.circle([lat, lng], {
                            radius: zone.radius || 100,
                            color: '#ff4444',
                            fillColor: '#ff4444',
                            fillOpacity: 0.3,
                            weight: 2
                        }).addTo(map);
                        
                        floodZone.bindPopup(`æ´ªæ°´åŒºåŸŸ<br>å¼ºåº¦: ${zone.intensity || 'æœªçŸ¥'}<br><button onclick="removeScenarioLayer(this, 'flood')">åˆ é™¤</button>`);
                        scenarioLayers.floodZones.push(floodZone);
                    }
                });
            }
            
            // åŠ è½½å®‰å…¨åŒºåŸŸ
            if (scenarioData.safe_zones) {
                scenarioData.safe_zones.forEach(zone => {
                    // å®‰å…¨æ£€æŸ¥åæ ‡å±æ€§
                    const lat = zone.lat || zone.latitude || 0;
                    const lng = zone.lng || zone.longitude || zone.lon || 0;
                    
                    if (lat && lng) {
                        const safeZone = L.circle([lat, lng], {
                            radius: zone.radius || 100,
                            color: '#44ff44',
                            fillColor: '#44ff44',
                            fillOpacity: 0.3,
                            weight: 2
                        }).addTo(map);
                        
                        safeZone.bindPopup(`å®‰å…¨åŒºåŸŸ<br>å®¹é‡: ${zone.capacity || 'æœªçŸ¥'}<br><button onclick="removeScenarioLayer(this, 'safe')">åˆ é™¤</button>`);
                        scenarioLayers.safeZones.push(safeZone);
                    }
                });
            }
            
            // åŠ è½½é“è·¯é˜»å¡
            if (scenarioData.barriers) {
                scenarioData.barriers.forEach(barrier => {
                    // å®‰å…¨æ£€æŸ¥åæ ‡å±æ€§
                    const lat = barrier.lat || barrier.latitude || 0;
                    const lng = barrier.lng || barrier.longitude || barrier.lon || 0;
                    
                    if (lat && lng) {
                        const barrierMarker = L.circleMarker([lat, lng], {
                            radius: 10,
                            color: '#ffaa00',
                            fillColor: '#ffaa00',
                            fillOpacity: 0.8,
                            weight: 3
                        }).addTo(map);
                        
                        barrierMarker.bindPopup(`é“è·¯é˜»å¡<br>ç±»å‹: ${barrier.type || 'æœªçŸ¥'}<br><button onclick="removeScenarioLayer(this, 'barrier')">åˆ é™¤</button>`);
                        scenarioLayers.barriers.push(barrierMarker);
                    }
                });
            }
        }
        
        // ç§»åŠ¨æ™ºèƒ½ä½“
        function moveAgentTo(agent, latlng) {
            agent.position = { lat: latlng.lat, lng: latlng.lng };
            sendCommand('move_agent', {
                agentId: agent.id,
                position: agent.position
            });
        }
        
        // æ›´æ–°å‚æ•°
        function updateParameter(paramName, value) {
            sendCommand('update_parameter', {
                parameter: paramName,
                value: value
            });
        }
        
        // æ›´æ–°ä»¿çœŸé€Ÿåº¦
        function updateSimulationSpeed(speed) {
            sendCommand('update_speed', { speed: speed });
        }
        
        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            alert('äº¤äº’å¼ä»¿çœŸä¸–ç•Œä½¿ç”¨è¯´æ˜ï¼š\n\n1. ä½¿ç”¨å·¦ä¾§æ§åˆ¶é¢æ¿æ§åˆ¶ä»¿çœŸ\n2. ç‚¹å‡»æ™ºèƒ½ä½“åˆ—è¡¨é€‰æ‹©æ™ºèƒ½ä½“\n3. åœ¨åœ°å›¾ä¸Šç‚¹å‡»ç§»åŠ¨é€‰ä¸­çš„æ™ºèƒ½ä½“\n4. ä½¿ç”¨åœºæ™¯ç¼–è¾‘å™¨æ·»åŠ ç¾å®³å’Œéšœç¢\n5. è§‚å¯Ÿåº•éƒ¨å›¾è¡¨äº†è§£ä»¿çœŸç»Ÿè®¡');
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
         function showNotification(message, type = 'info') {
             // åˆ›å»ºé€šçŸ¥å…ƒç´ 
             const notification = document.createElement('div');
             notification.style.cssText = `
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 padding: 15px 20px;
                 border-radius: 5px;
                 color: white;
                 font-weight: bold;
                 z-index: 9999;
                 max-width: 300px;
                 word-wrap: break-word;
                 transition: all 0.3s ease;
             `;
             
             // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
             switch(type) {
                 case 'success':
                     notification.style.backgroundColor = '#4ecdc4';
                     break;
                 case 'warning':
                     notification.style.backgroundColor = '#ffa07a';
                     break;
                 case 'error':
                     notification.style.backgroundColor = '#ff6b6b';
                     break;
                 default:
                     notification.style.backgroundColor = '#45b7d1';
             }
             
             notification.textContent = message;
             document.body.appendChild(notification);
             
             // 3ç§’åè‡ªåŠ¨ç§»é™¤
             setTimeout(() => {
                 notification.style.opacity = '0';
                 setTimeout(() => {
                     if (notification.parentNode) {
                         notification.parentNode.removeChild(notification);
                     }
                 }, 300);
             }, 3000);
         }
         
         // æ•°æ®å¯¼å‡ºåŠŸèƒ½
         function exportSimulationData() {
             const exportData = {
                 timestamp: new Date().toISOString(),
                 simulationState: {
                     status: simulationState,
                     step: currentStep,
                     speed: simulationSpeed
                 },
                 agents: agents.map(agent => ({
                     id: agent.id,
                     type: agent.type,
                     position: agent.position,
                     resources: agent.resources,
                     risk: agent.risk,
                     status: agent.status
                 })),
                 parameters: {
                     agentCount: parseInt(document.getElementById('agentCount').value),
                     floodIntensity: parseFloat(document.getElementById('floodIntensity').value),
                     networkDensity: parseFloat(document.getElementById('networkDensity').value)
                 },
                 statistics: {
                     activeAgents: document.getElementById('activeAgents').textContent,
                     evacuatedCount: document.getElementById('evacuatedCount').textContent,
                     helpActions: document.getElementById('helpActions').textContent
                 }
             };
             
             downloadJSON(exportData, `simulation_data_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`);
             showNotification('ä»¿çœŸæ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
         }
         
         function exportCharts() {
             const chartsToExport = ['populationChart', 'behaviorChart', 'riskChart'];
             const zip = new JSZip();
             
             chartsToExport.forEach(chartId => {
                 const canvas = document.getElementById(chartId);
                 if (canvas) {
                     const imageData = canvas.toDataURL('image/png');
                     const base64Data = imageData.split(',')[1];
                     zip.file(`${chartId}.png`, base64Data, {base64: true});
                 }
             });
             
             zip.generateAsync({type: 'blob'}).then(function(content) {
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(content);
                 link.download = `charts_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.zip`;
                 link.click();
                 showNotification('å›¾è¡¨å¯¼å‡ºæˆåŠŸ', 'success');
             });
         }
         
         function generateReport() {
             const reportData = {
                 title: 'æ´ªç¾æ™ºèƒ½ä½“ä»¿çœŸæŠ¥å‘Š',
                 generatedAt: new Date().toLocaleString('zh-CN'),
                 summary: {
                     totalSteps: currentStep,
                     totalAgents: agents.length,
                     activeAgents: document.getElementById('activeAgents').textContent,
                     evacuatedCount: document.getElementById('evacuatedCount').textContent,
                     helpActions: document.getElementById('helpActions').textContent
                 },
                 parameters: {
                     agentCount: parseInt(document.getElementById('agentCount').value),
                     floodIntensity: parseFloat(document.getElementById('floodIntensity').value),
                     networkDensity: parseFloat(document.getElementById('networkDensity').value)
                 },
                 agentTypes: {
                     normal: agents.filter(a => a.type === 'normal').length,
                     vulnerable: agents.filter(a => a.type === 'vulnerable').length,
                     helper: agents.filter(a => a.type === 'helper').length
                 },
                 riskDistribution: {
                     low: agents.filter(a => a.risk < 0.3).length,
                     medium: agents.filter(a => a.risk >= 0.3 && a.risk < 0.7).length,
                     high: agents.filter(a => a.risk >= 0.7).length
                 }
             };
             
             // ç”ŸæˆHTMLæŠ¥å‘Š
             const reportHTML = generateReportHTML(reportData);
             downloadHTML(reportHTML, `simulation_report_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.html`);
             showNotification('ä»¿çœŸæŠ¥å‘Šç”ŸæˆæˆåŠŸ', 'success');
         }
         
         function exportScenario() {
             const scenarioData = {
                 timestamp: new Date().toISOString(),
                 scenario: simulation_state?.scenario || {flood_zones: [], safe_zones: [], barriers: []},
                 parameters: {
                     agentCount: parseInt(document.getElementById('agentCount').value),
                     floodIntensity: parseFloat(document.getElementById('floodIntensity').value),
                     networkDensity: parseFloat(document.getElementById('networkDensity').value)
                 },
                 mapCenter: map ? map.getCenter() : null,
                 mapZoom: map ? map.getZoom() : null
             };
             
             downloadJSON(scenarioData, `scenario_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`);
             showNotification('åœºæ™¯é…ç½®å¯¼å‡ºæˆåŠŸ', 'success');
         }
         
         // è¾…åŠ©å‡½æ•°
         function downloadJSON(data, filename) {
             const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = filename;
             link.click();
         }
         
         function downloadHTML(html, filename) {
             const blob = new Blob([html], {type: 'text/html'});
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = filename;
             link.click();
         }
         
         function generateReportHTML(data) {
             return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.title}</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .section { margin: 30px 0; }
        .section h2 { color: #333; border-left: 4px solid #007bff; padding-left: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>${data.title}</h1>
        <p>ç”Ÿæˆæ—¶é—´: ${data.generatedAt}</p>
    </div>
    
    <div class="section">
        <h2>ä»¿çœŸæ¦‚è§ˆ</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">${data.summary.totalSteps}</div>
                <div>ä»¿çœŸæ­¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.summary.totalAgents}</div>
                <div>æ™ºèƒ½ä½“æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.summary.activeAgents}</div>
                <div>æ´»è·ƒæ™ºèƒ½ä½“</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.summary.evacuatedCount}</div>
                <div>ç–æ•£äººæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${data.summary.helpActions}</div>
                <div>å¸®åŠ©è¡Œä¸º</div>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>ä»¿çœŸå‚æ•°</h2>
        <table>
            <tr><th>å‚æ•°</th><th>å€¼</th></tr>
            <tr><td>æ™ºèƒ½ä½“æ•°é‡</td><td>${data.parameters.agentCount}</td></tr>
            <tr><td>æ´ªæ°´å¼ºåº¦</td><td>${data.parameters.floodIntensity}</td></tr>
            <tr><td>ç¤¾äº¤ç½‘ç»œå¯†åº¦</td><td>${data.parameters.networkDensity}</td></tr>
        </table>
    </div>
    
    <div class="section">
        <h2>æ™ºèƒ½ä½“ç±»å‹åˆ†å¸ƒ</h2>
        <table>
            <tr><th>ç±»å‹</th><th>æ•°é‡</th></tr>
            <tr><td>æ™®é€šæ™ºèƒ½ä½“</td><td>${data.agentTypes.normal}</td></tr>
            <tr><td>è„†å¼±æ™ºèƒ½ä½“</td><td>${data.agentTypes.vulnerable}</td></tr>
            <tr><td>å¸®åŠ©è€…</td><td>${data.agentTypes.helper}</td></tr>
        </table>
    </div>
    
    <div class="section">
        <h2>é£é™©ç­‰çº§åˆ†å¸ƒ</h2>
        <table>
            <tr><th>é£é™©ç­‰çº§</th><th>æ•°é‡</th></tr>
            <tr><td>ä½é£é™© (< 0.3)</td><td>${data.riskDistribution.low}</td></tr>
            <tr><td>ä¸­é£é™© (0.3-0.7)</td><td>${data.riskDistribution.medium}</td></tr>
            <tr><td>é«˜é£é™© (> 0.7)</td><td>${data.riskDistribution.high}</td></tr>
        </table>
    </div>
</body>
</html>
             `;
         }
         
         // åŠ è½½æ§åˆ¶é€»è¾‘
         function hideLoadingIndicator() {
             const loadingIndicator = document.getElementById('loadingIndicator');
             if (loadingIndicator) {
                 loadingIndicator.style.opacity = '0';
                 setTimeout(() => {
                     loadingIndicator.style.display = 'none';
                 }, 300);
             }
         }
         
         function showLoadingIndicator(message = 'æ­£åœ¨åŠ è½½...') {
             const loadingIndicator = document.getElementById('loadingIndicator');
             if (loadingIndicator) {
                 loadingIndicator.querySelector('p').textContent = message;
                 loadingIndicator.style.display = 'flex';
                 loadingIndicator.style.opacity = '1';
             }
         }
         
         // é¡µé¢åŠ è½½å®Œæˆåéšè—åŠ è½½æŒ‡ç¤ºå™¨
         document.addEventListener('DOMContentLoaded', function() {
             // ç«‹å³éšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼Œå› ä¸ºDOMå·²ç»åŠ è½½å®Œæˆ
             setTimeout(() => {
                 hideLoadingIndicator();
             }, 1000); // å»¶è¿Ÿ1ç§’ä»¥ç¡®ä¿æ‰€æœ‰åˆå§‹åŒ–å®Œæˆ
             
             // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåå†æ¬¡ç¡®ä¿éšè—
             window.addEventListener('load', function() {
                 setTimeout(() => {
                     hideLoadingIndicator();
                 }, 500);
             });
         });
         
         // WebSocketè¿æ¥äº‹ä»¶å¤„ç†ï¼ˆå»¶è¿Ÿç»‘å®šï¼‰
         setTimeout(function() {
             if (typeof window.socket !== 'undefined' && window.socket) {
                 window.socket.on('connect', function() {
                     console.log('Socketè¿æ¥æˆåŠŸï¼Œéšè—åŠ è½½æŒ‡ç¤ºå™¨');
                     hideLoadingIndicator();
                 });
                 
                 window.socket.on('disconnect', function() {
                     showLoadingIndicator('è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...');
                 });
             } else {
                 console.log('Socketæœªåˆå§‹åŒ–ï¼Œç›´æ¥éšè—åŠ è½½æŒ‡ç¤ºå™¨');
                 hideLoadingIndicator();
             }
         }, 3000); // å»¶è¿Ÿ3ç§’ç­‰å¾…socketåˆå§‹åŒ–
         
         // æ—¶é—´è½´åŠŸèƒ½
         let isSimulationPaused = false;
         let maxSteps = 1000; // é»˜è®¤æœ€å¤§æ­¥æ•°ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
         
         // åˆå§‹åŒ–æ—¶é—´è½´
         function initializeTimeline() {
             const playPauseBtn = document.getElementById('playPauseBtn');
             const resetBtn = document.getElementById('resetBtn');
             const timelineThumb = document.getElementById('timelineThumb');
             const timelineTrack = document.querySelector('.timeline-track');
             
             // æ’­æ”¾/æš‚åœæŒ‰é’®äº‹ä»¶
             playPauseBtn.addEventListener('click', function() {
                 toggleSimulation();
             });
             
             // é‡ç½®æŒ‰é’®äº‹ä»¶
             resetBtn.addEventListener('click', function() {
                 resetSimulation();
             });
             
             // é€Ÿåº¦æ§åˆ¶å™¨äº‹ä»¶ç»‘å®š
             const speedSlider = document.getElementById('speedControl');
             const speedValue = document.getElementById('speedValue');
             const speedPresets = document.querySelectorAll('.speed-preset');
             
             // é€Ÿåº¦æ»‘å—äº‹ä»¶
             if (speedSlider && speedValue) {
                 speedSlider.addEventListener('input', function(e) {
                     const speed = parseFloat(e.target.value);
                     simulationSpeed = speed;
                     speedValue.textContent = speed.toFixed(1) + 'x';
                     updateSimulationSpeed(speed);
                     
                     // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
                     speedPresets.forEach(btn => {
                         btn.classList.remove('active');
                         if (parseFloat(btn.dataset.speed) === speed) {
                             btn.classList.add('active');
                         }
                     });
                 });
             }
             
             // é€Ÿåº¦é¢„è®¾æŒ‰é’®äº‹ä»¶
             speedPresets.forEach(btn => {
                 btn.addEventListener('click', function() {
                     const speed = parseFloat(this.dataset.speed);
                     simulationSpeed = speed;
                     
                     if (speedSlider) speedSlider.value = speed;
                     if (speedValue) speedValue.textContent = speed.toFixed(1) + 'x';
                     
                     updateSimulationSpeed(speed);
                     
                     // æ›´æ–°æŒ‰é’®çŠ¶æ€
                     speedPresets.forEach(b => b.classList.remove('active'));
                     this.classList.add('active');
                 });
             });
             
             // æ—¶é—´è½´æ‹–æ‹½åŠŸèƒ½
             let isDragging = false;
             
             timelineThumb.addEventListener('mousedown', function(e) {
                 isDragging = true;
                 e.preventDefault();
             });
             
             document.addEventListener('mousemove', function(e) {
                 if (!isDragging) return;
                 
                 const rect = timelineTrack.getBoundingClientRect();
                 const x = e.clientX - rect.left;
                 const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
                 
                 updateTimelinePosition(percentage);
                 
                 // è®¡ç®—å¯¹åº”çš„æ­¥æ•°å¹¶å‘é€è·³è½¬å‘½ä»¤
                 const targetStep = Math.floor((percentage / 100) * maxSteps);
                 jumpToStep(targetStep);
             });
             
             document.addEventListener('mouseup', function() {
                 isDragging = false;
             });
             
             // ç‚¹å‡»æ—¶é—´è½´è·³è½¬
             timelineTrack.addEventListener('click', function(e) {
                 if (e.target === timelineThumb) return;
                 
                 const rect = timelineTrack.getBoundingClientRect();
                 const x = e.clientX - rect.left;
                 const percentage = (x / rect.width) * 100;
                 
                 updateTimelinePosition(percentage);
                 
                 const targetStep = Math.floor((percentage / 100) * maxSteps);
                 jumpToStep(targetStep);
             });
         }
         
         // æ›´æ–°æ—¶é—´è½´ä½ç½®
         function updateTimelinePosition(percentage) {
             const timelineProgress = document.getElementById('timelineProgress');
             const timelineThumb = document.getElementById('timelineThumb');
             
             timelineProgress.style.width = percentage + '%';
             timelineThumb.style.left = percentage + '%';
         }
         
         // æ›´æ–°æ—¶é—´è½´æ˜¾ç¤º
        function updateTimeline(currentStep) {
            const timelineStep = document.getElementById('timelineStep');
            const percentage = maxSteps > 0 ? (currentStep / maxSteps) * 100 : 0;
            
            timelineStep.textContent = currentStep;
            updateTimelinePosition(Math.min(100, percentage));
        }
        
        // æ™ºèƒ½ä½“çŠ¶æ€æ¨¡æ€æ¡†åŠŸèƒ½
        let allAgentsData = [];
        let filteredAgentsData = [];
        
        // æ˜¾ç¤ºæ‰€æœ‰æ™ºèƒ½ä½“çŠ¶æ€
        function showAllAgentsStatus() {
            const modal = new bootstrap.Modal(document.getElementById('agentStatusModal'));
            modal.show();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('agentStatusLoading').style.display = 'block';
            document.getElementById('agentStatusGrid').innerHTML = '';
            
            // è·å–æ™ºèƒ½ä½“æ•°æ®
            refreshAgentStatus();
        }
        
        // åˆ‡æ¢åœ°å›¾æ€§èƒ½ç›‘æ§é¢æ¿
        function toggleMapPerformance() {
            const panel = document.getElementById('mapPerformancePanel');
            const btn = document.getElementById('mapPerformanceBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-tachometer-alt"></i> éšè—';
                btn.classList.remove('btn-outline-info');
                btn.classList.add('btn-info');
            } else {
                panel.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-tachometer-alt"></i> ç›‘æ§';
                btn.classList.remove('btn-info');
                btn.classList.add('btn-outline-info');
            }
        }
        
        // åˆ·æ–°æ™ºèƒ½ä½“çŠ¶æ€
        function refreshAgentStatus() {
            // æ¨¡æ‹Ÿè·å–æ™ºèƒ½ä½“æ•°æ®ï¼ˆå®é™…åº”è¯¥ä»åç«¯APIè·å–ï¼‰
            setTimeout(() => {
                // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                allAgentsData = generateMockAgentData();
                filteredAgentsData = [...allAgentsData];
                
                renderAgentCards();
                document.getElementById('agentStatusLoading').style.display = 'none';
            }, 1000);
        }
        
        // ç”Ÿæˆæ¨¡æ‹Ÿæ™ºèƒ½ä½“æ•°æ®
        function generateMockAgentData() {
            const types = ['æ™®é€šå±…æ°‘', 'ç¤¾åŒºé¢†è¢–', 'æ•‘æ´äººå‘˜'];
            const statuses = ['æ­£å¸¸', 'ç–æ•£ä¸­', 'å·²ç–æ•£', 'å¸®åŠ©ä»–äºº'];
            const agents = [];
            
            for (let i = 1; i <= 30; i++) {
                agents.push({
                    id: `agent_${i}`,
                    type: types[Math.floor(Math.random() * types.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    position: {
                        x: Math.floor(Math.random() * 1000),
                        y: Math.floor(Math.random() * 1000)
                    },
                    health: Math.floor(Math.random() * 100),
                    energy: Math.floor(Math.random() * 100),
                    social_connections: Math.floor(Math.random() * 10),
                    help_count: Math.floor(Math.random() * 5),
                    evacuation_time: Math.floor(Math.random() * 300)
                });
            }
            
            return agents;
        }
        
        // æ¸²æŸ“æ™ºèƒ½ä½“å¡ç‰‡
        function renderAgentCards() {
            const grid = document.getElementById('agentStatusGrid');
            grid.innerHTML = '';
            
            filteredAgentsData.forEach(agent => {
                const card = createAgentCard(agent);
                grid.appendChild(card);
            });
        }
        
        // åˆ›å»ºæ™ºèƒ½ä½“å¡ç‰‡
        function createAgentCard(agent) {
            const card = document.createElement('div');
            card.className = 'agent-card';
            
            const statusClass = getStatusClass(agent.status);
            
            card.innerHTML = `
                <div class="agent-card-header">
                    <span class="agent-id">${agent.id}</span>
                    <span class="agent-type">${agent.type}</span>
                </div>
                <div class="agent-status ${statusClass}">${agent.status}</div>
                <div class="agent-details">
                    <div class="detail-item">
                        <span class="detail-label">å¥åº·çŠ¶æ€:</span>
                        <span>${agent.health}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">èƒ½é‡æ°´å¹³:</span>
                        <span>${agent.energy}%</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ç¤¾äº¤è¿æ¥:</span>
                        <span>${agent.social_connections}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å¸®åŠ©æ¬¡æ•°:</span>
                        <span>${agent.help_count}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ç–æ•£æ—¶é—´:</span>
                        <span>${agent.evacuation_time}s</span>
                    </div>
                </div>
                <div class="agent-position">
                    ä½ç½®: (${agent.position.x}, ${agent.position.y})
                </div>
            `;
            
            return card;
        }
        
        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch(status) {
                case 'æ­£å¸¸': return 'status-normal';
                case 'ç–æ•£ä¸­': return 'status-evacuating';
                case 'å·²ç–æ•£': return 'status-evacuated';
                case 'å¸®åŠ©ä»–äºº': return 'status-helping';
                default: return 'status-normal';
            }
        }
        
        // æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
        function initializeAgentFilters() {
            const searchInput = document.getElementById('agentSearchInput');
            const typeFilter = document.getElementById('agentTypeFilter');
            const statusFilter = document.getElementById('agentStatusFilter');
            
            // æœç´¢åŠŸèƒ½
            searchInput.addEventListener('input', filterAgents);
            typeFilter.addEventListener('change', filterAgents);
            statusFilter.addEventListener('change', filterAgents);
        }
        
        // è¿‡æ»¤æ™ºèƒ½ä½“
        function filterAgents() {
            const searchTerm = document.getElementById('agentSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('agentTypeFilter').value;
            const statusFilter = document.getElementById('agentStatusFilter').value;
            
            filteredAgentsData = allAgentsData.filter(agent => {
                const matchesSearch = !searchTerm || 
                    agent.id.toLowerCase().includes(searchTerm) ||
                    agent.type.toLowerCase().includes(searchTerm) ||
                    agent.status.toLowerCase().includes(searchTerm);
                    
                const matchesType = !typeFilter || agent.type === typeFilter;
                const matchesStatus = !statusFilter || agent.status === statusFilter;
                
                return matchesSearch && matchesType && matchesStatus;
            });
            
            renderAgentCards();
        }
         
         // æ›´æ–°ä»¿çœŸæ§ä»¶çŠ¶æ€
         function updateSimulationControls() {
             const playPauseBtn = document.getElementById('playPauseBtn');
             const icon = playPauseBtn.querySelector('i');
             
             if (isSimulationPaused) {
                 icon.className = 'fas fa-play';
             } else {
                 icon.className = 'fas fa-pause';
             }
         }
         
         // åˆ‡æ¢ä»¿çœŸçŠ¶æ€
         function toggleSimulation() {
             const playPauseBtn = document.getElementById('playPauseBtn');
             const icon = playPauseBtn.querySelector('i');
             
             isSimulationPaused = !isSimulationPaused;
             
             if (isSimulationPaused) {
                 icon.className = 'fas fa-play';
                 sendCommand('pause_simulation');
             } else {
                 icon.className = 'fas fa-pause';
                 sendCommand('resume_simulation');
             }
         }
         
         // é‡ç½®ä»¿çœŸ
         function resetSimulation() {
             const playPauseBtn = document.getElementById('playPauseBtn');
             const icon = playPauseBtn.querySelector('i');
             
             isSimulationPaused = false;
             icon.className = 'fas fa-pause';
             
             updateTimeline(0);
             sendCommand('reset_simulation');
         }
         
         // è·³è½¬åˆ°æŒ‡å®šæ­¥æ•°
         function jumpToStep(step) {
             sendCommand('jump_to_step', { step: step });
         }
         
         // ä¿®æ”¹ç°æœ‰çš„handleSimulationUpdateå‡½æ•°ä»¥æ›´æ–°æ—¶é—´è½´
         const originalHandleSimulationUpdate = handleSimulationUpdate;
         handleSimulationUpdate = function(data) {
             originalHandleSimulationUpdate(data);
             
             if (data.type === 'step_update' && data.step !== undefined) {
                 updateTimeline(data.step);
                 
                 // åŠ¨æ€è°ƒæ•´æœ€å¤§æ­¥æ•°
                 if (data.maxSteps) {
                     maxSteps = data.maxSteps;
                 }
             }
         };
         
         // ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½
         let sidebarCollapsed = false;
         
         function initializeSidebar() {
             const sidebarToggle = document.getElementById('sidebarToggle');
             const controlSidebar = document.getElementById('controlSidebar');
             
             sidebarToggle.addEventListener('click', function() {
                 toggleSidebar();
             });
         }
         
         function toggleSidebar() {
             const controlSidebar = document.getElementById('controlSidebar');
             const toggleIcon = document.querySelector('#sidebarToggle i');
             
             sidebarCollapsed = !sidebarCollapsed;
             
             if (sidebarCollapsed) {
                 controlSidebar.classList.add('collapsed');
                 toggleIcon.className = 'fas fa-chevron-right';
             } else {
                 controlSidebar.classList.remove('collapsed');
                 toggleIcon.className = 'fas fa-chevron-left';
             }
         }
         
         // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ—¶é—´è½´å’Œä¾§è¾¹æ 
         document.addEventListener('DOMContentLoaded', function() {
            initializeTimeline();
            initializeSidebar();
            initializeAgentFilters();
        });
    </script>
</body>
</html>